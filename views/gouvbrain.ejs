<%
/*
gouvbrain.ejs ‚Äî AI Cabinet Meeting Dashboard (Gov of Congo)
‚úÖ NO MOCKS / NO DEMO MODE
‚úÖ All buttons call real APIs
‚úÖ Status lights are live (polling health endpoints)

Expected (optional) server-side variables:
  - user: { name }
  - cabinetTitle: string
  - meetingName: string
  - personas: [{ id, name, role, ministry, focus, color, avatarEmoji }]

Backend endpoints (CURRENT SAFE MODE):
  ‚úÖ POST /api/gouvbrain/ingest        (multipart/form-data: pdf) -> { docId, title, pages, summary, keyTopics[] }
  ‚úÖ POST /api/ollama/chat             (json Ollama chat payload) -> { message: { content } } (or proxy-compatible)
  ‚úÖ GET  /api/health
  ‚úÖ GET  /api/ollama/health
  ‚úÖ GET  /api/ollama/tags

Notes:
  - Multi-persona analysis is performed CLIENT-SIDE (loops over personas calling /api/ollama/chat).
  - /api/gouvbrain/analyze and /api/gouvbrain/doc/:docId are NOT REQUIRED in this safe version.
*/
%>

<%
  const DEFAULT_PERSONAS = [
    { id:"pm", name:"Premier Ministre", role:"Chair", ministry:"Primature", focus:"Arbitrage, priorit√©s, ex√©cution", color:"#22c55e", avatarEmoji:"üü¢" },
    { id:"fin", name:"Ministre des Finances", role:"SME", ministry:"Finances", focus:"Budget, fiscalit√©, soutenabilit√©", color:"#f59e0b", avatarEmoji:"üü†" },
    { id:"plan", name:"Plan & D√©veloppement", role:"SME", ministry:"Plan", focus:"ROI, investissements, PPP", color:"#a855f7", avatarEmoji:"üü£" },
    { id:"int", name:"Int√©rieur", role:"SME", ministry:"Int√©rieur", focus:"S√©curit√© int√©rieure, gouvernance locale", color:"#3b82f6", avatarEmoji:"üîµ" },
    { id:"just", name:"Justice", role:"SME", ministry:"Justice", focus:"Conformit√©, risques juridiques", color:"#ef4444", avatarEmoji:"üî¥" },
    { id:"def", name:"D√©fense", role:"SME", ministry:"D√©fense", focus:"Souverainet√©, risques strat√©giques", color:"#64748b", avatarEmoji:"‚ö´" },
    { id:"health", name:"Sant√©", role:"SME", ministry:"Sant√©", focus:"Impact sanitaire, urgence, capacit√©s", color:"#14b8a6", avatarEmoji:"üü¶" },
    { id:"edu", name:"√âducation", role:"SME", ministry:"√âducation", focus:"Comp√©tences, formation, inclusion", color:"#06b6d4", avatarEmoji:"üßä" },
    { id:"energy", name:"Hydrocarbures & √ânergie", role:"SME", ministry:"√ânergie", focus:"√ânergie, cha√Æne de valeur, revenus", color:"#fb7185", avatarEmoji:"üå∏" },
    { id:"digital", name:"√âconomie Num√©rique", role:"SME", ministry:"Num√©rique", focus:"Data, IA, cyber, interop√©rabilit√©", color:"#10b981", avatarEmoji:"üü©" },
    { id:"env", name:"Environnement", role:"SME", ministry:"Environnement", focus:"ESG, conformit√©, climat", color:"#84cc16", avatarEmoji:"üü©" },
  ];

  const cabinetTitle = typeof locals.cabinetTitle !== "undefined" ? locals.cabinetTitle : "GouvBrain ‚Äî Conseil des Ministres (R√©publique du Congo)";
  const meetingName  = typeof locals.meetingName  !== "undefined" ? locals.meetingName  : "Session IA ‚Ä¢ Analyse & D√©cision";
  const personas     = (locals.personas && locals.personas.length) ? locals.personas : DEFAULT_PERSONAS;
  const userName     = (locals.user && locals.user.name) ? locals.user.name : "Secr√©tariat G√©n√©ral";
%>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= cabinetTitle %></title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --card:#0E1A2B;
      --card2:#0B1525;
      --txt:#EAF2FF;
      --muted:#9FB2D0;
      --line:rgba(255,255,255,.08);
      --glow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 22px;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --off:rgba(255,255,255,.18);
    }

    html,body{height:100%; background: radial-gradient(1200px 600px at 15% 0%, rgba(34,197,94,.18), transparent 55%),
                             radial-gradient(900px 500px at 85% 10%, rgba(59,130,246,.18), transparent 60%),
                             radial-gradient(900px 600px at 50% 90%, rgba(168,85,247,.14), transparent 60%),
                             linear-gradient(180deg, var(--bg0), var(--bg1));
              color:var(--txt);}

    .app-shell{ height:100%; display:flex; flex-direction:column; overflow:hidden; }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(7,10,18,.68);
      border-bottom:1px solid var(--line);
    }

    .brand-pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding:.5rem .9rem;
      display:flex; align-items:center; gap:.6rem;
    }

    .brand-dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, #22c55e, #3b82f6);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12), 0 0 22px rgba(59,130,246,.35);
    }

    .status-pills{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .sp{
      border:1px solid var(--line);
      border-radius:999px;
      padding:.28rem .55rem;
      background: rgba(255,255,255,.03);
      font-size:.78rem;
      color: var(--muted);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .led{
      width:10px; height:10px; border-radius:999px;
      background: var(--off);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .led.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,.14), 0 0 18px rgba(34,197,94,.35); }
    .led.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.16), 0 0 18px rgba(245,158,11,.35); }
    .led.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.14), 0 0 18px rgba(239,68,68,.35); }

    .main{ flex:1; overflow:hidden; padding: 14px 14px 0 14px; }

    .grid{
      height:100%;
      display:grid;
      grid-template-columns: 360px 1.25fr 420px;
      gap: 14px;
      overflow:hidden;
    }

    @media (max-width: 1200px){
      .grid{ grid-template-columns: 1fr; }
      .panel{ min-height: 380px; }
    }

    .panel{
      background: rgba(14,26,43,.72);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--glow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .panel-header{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
    }

    .panel-title{
      display:flex; gap:.65rem; align-items:center;
      font-weight:700;
      letter-spacing:.2px;
    }

    .chip{
      font-size:.78rem;
      color: var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:.25rem .55rem;
      background: rgba(255,255,255,.03);
    }

    .persona-list{ padding: 12px; overflow:auto; flex:1; }

    .persona-card{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
      display:flex;
      gap:12px;
      align-items:stretch;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      position:relative;
      overflow:hidden;
    }
    .persona-card:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
    }
    .persona-card.active{
      outline: 2px solid rgba(59,130,246,.45);
      box-shadow: 0 0 0 6px rgba(59,130,246,.10), 0 22px 60px rgba(0,0,0,.55);
    }
    .persona-aura{
      position:absolute; inset:-60px -60px auto auto;
      width:180px; height:180px; border-radius: 999px;
      filter: blur(18px);
      opacity:.35;
      pointer-events:none;
      transform: translate(10px, -10px);
    }

    .avatar{
      width:54px; height:54px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      font-size: 1.3rem;
      flex: 0 0 auto;
      position:relative;
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(59,130,246,.18), rgba(168,85,247,.16));
      z-index:-1;
      filter: blur(10px);
      opacity:.55;
    }

    .persona-meta{ flex:1; min-width:0; }
    .persona-meta h6{ margin:0; font-weight:800; }
    .persona-meta p{ margin:.25rem 0 0; color:var(--muted); font-size:.88rem; line-height:1.2; }
    .persona-mini{ display:flex; flex-wrap:wrap; gap:6px; margin-top:.5rem; }

    .chat-wrap{
      padding: 12px;
      overflow:auto;
      flex:1;
      background:
        radial-gradient(650px 280px at 30% 0%, rgba(34,197,94,.08), transparent 60%),
        radial-gradient(650px 280px at 70% 0%, rgba(59,130,246,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
    }

    .msg{ display:flex; gap:10px; margin-bottom: 10px; align-items:flex-start; }
    .msg .bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      white-space:pre-wrap;
    }
    .msg.me{ justify-content:flex-end; }
    .msg.me .bubble{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); }
    .msg .who{ font-size:.78rem; color: var(--muted); margin-bottom: 3px; display:flex; align-items:center; gap:6px; }

    .composer{
      padding: 12px;
      border-top:1px solid var(--line);
      background: rgba(7,10,18,.45);
    }

    .composer .form-control{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--txt);
      border-radius: 16px;
    }
    .composer .form-control:focus{
      box-shadow: 0 0 0 .25rem rgba(59,130,246,.15);
      border-color: rgba(59,130,246,.3);
    }

    .doc-body{ padding: 12px; overflow:auto; flex:1; }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background: rgba(255,255,255,.02);
    }
    .box .label{ color: var(--muted); font-size:.78rem; }
    .box .value{ font-weight:800; font-size:1.05rem; margin-top:2px; }

    .analysis-card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }
    .analysis-card h6{ margin:0 0 6px 0; font-weight:800; }
    .analysis-card ul{ margin: 0; padding-left: 18px; color: var(--muted); }
    .analysis-card .stance{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: .25rem .55rem;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:.78rem;
      color: var(--muted);
      background: rgba(255,255,255,.02);
      margin-bottom: 8px;
    }

    .footerbar{
      position:sticky; bottom:0; z-index:50;
      border-top:1px solid var(--line);
      background: rgba(7,10,18,.68);
      backdrop-filter: blur(14px);
      padding: 10px 14px;
    }

    .dropzone{
      border: 1.5px dashed rgba(255,255,255,.18);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      transition: border-color .18s ease, background .18s ease, transform .18s ease;
    }
    .dropzone.dragover{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.08);
      transform: translateY(-1px);
    }

    .tiny{ font-size:.82rem; color: var(--muted); }

    .btn-soft{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--txt);
    }
    .btn-soft:hover{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--txt);
    }

    .progress{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .progress-bar{ width:0%; transition: width .18s ease; }

    .blink{ animation: blink 1.1s infinite ease-in-out; }
    @keyframes blink{ 0%,100%{ opacity:.35; } 50%{ opacity:1; } }
  </style>
</head>

<body>
  <div class="app-shell">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="container-fluid py-2">
        <div class="d-flex align-items-center justify-content-between gap-2">
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="brand-pill">
              <span class="brand-dot"></span>
              <div>
                <div class="fw-bold" style="line-height:1.05"><%= cabinetTitle %></div>
                <div class="tiny"><i class="bi bi-stars"></i> <%= meetingName %> ‚Ä¢ <span class="blink">LIVE</span></div>
              </div>
            </div>

            <div class="status-pills ms-1">
              <div class="sp" title="API principale">
                <span class="led" id="ledApi"></span> API
              </div>
              <div class="sp" title="Ollama">
                <span class="led" id="ledOllama"></span> Ollama
              </div>
              <div class="sp" title="Aidesk">
                <span class="led" id="ledAidesk"></span> Aidesk
              </div>
              <div class="sp" title="Firewall stats">
                <span class="led" id="ledFirewall"></span> Firewall
              </div>
            </div>

            <span class="chip d-none d-md-inline"><i class="bi bi-shield-lock"></i> Mode confidentiel</span>
            <span class="chip d-none d-lg-inline"><i class="bi bi-diagram-3"></i> Personas synchronis√©es</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="chip"><i class="bi bi-person-circle"></i> <%= userName %></span>
            <button class="btn btn-soft btn-sm" id="btnClear"><i class="bi bi-trash3"></i> Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="grid">

        <!-- LEFT: PERSONAS -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-people"></i>
              Cabinet IA
              <span class="chip" id="docChip">Aucun document</span>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-soft btn-sm" id="btnAnalyzeAll" title="Lancer l‚Äôanalyse multi-personas">
                <i class="bi bi-lightning-charge"></i>
              </button>
            </div>
          </div>

          <div class="persona-list" id="personaList">
            <% personas.forEach(p => { %>
              <div class="persona-card mb-2" data-persona-id="<%= p.id %>" tabindex="0">
                <div class="persona-aura" style="background:<%= p.color %>;"></div>
                <div class="avatar" style="box-shadow: 0 0 0 4px rgba(255,255,255,.03), 0 0 32px <%= p.color %>33;">
                  <span><%= p.avatarEmoji || "ü§ñ" %></span>
                </div>
                <div class="persona-meta">
                  <h6><%= p.name %></h6>
                  <p><span class="fw-semibold"><%= p.ministry %></span> ‚Ä¢ <%= p.focus %></p>
                  <div class="persona-mini">
                    <span class="chip"><i class="bi bi-person-badge"></i> <%= p.role %></span>
                    <span class="chip"><i class="bi bi-eye"></i> Perspective</span>
                    <span class="chip"><i class="bi bi-zoom-in"></i> Zoom</span>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- CENTER: CHATBOARD -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-chat-dots"></i>
              Chatboard Cabinet
              <span class="chip" id="modeChip">Mode: Cabinet</span>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <select class="form-select form-select-sm" id="personaMode" style="width: 220px; background: rgba(255,255,255,.03); color: var(--txt); border-color: rgba(255,255,255,.10); border-radius: 14px;">
                <option value="cabinet">Cabinet (tous)</option>
                <option value="single">Persona s√©lectionn√©e</option>
              </select>
              <button class="btn btn-soft btn-sm" id="btnSummarize"><i class="bi bi-file-text"></i> R√©sumer</button>
            </div>
          </div>

          <div class="chat-wrap" id="chatWrap">
            <div class="msg">
              <div class="avatar" style="width:38px;height:38px;border-radius:14px;">
                <span>üß†</span>
              </div>
              <div>
                <div class="who">GouvBrain <span class="chip">syst√®me</span></div>
                <div class="bubble">
Bienvenue. D√©posez un PDF dans la zone d‚Äôingestion en bas.
Ensuite, chaque membre du cabinet IA produira une analyse (risques, opportunit√©s, d√©cisions, actions).
                </div>
              </div>
            </div>
          </div>

          <div class="composer">
            <div class="d-flex gap-2">
              <input id="chatInput" class="form-control" placeholder="Posez une question au Cabinet IA‚Ä¶ (ex: 'Quels risques budg√©taires ?' / 'D√©cision recommand√©e ?')" />
              <button class="btn btn-soft" id="btnSend"><i class="bi bi-send"></i></button>
            </div>
            <div class="d-flex align-items-center justify-content-between mt-2">
              <div class="tiny">
                <i class="bi bi-info-circle"></i>
                Astuce: utilisez <span class="chip">Mode Persona</span> pour interroger un seul expert.
              </div>
              <div class="tiny" id="statusLine">‚óè Pr√™t</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: DOCUMENT + ANALYSIS -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-file-earmark-pdf"></i>
              Dossier & Analyses
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-soft btn-sm" id="btnExport" title="Exporter (via API si disponible)">
                <i class="bi bi-download"></i>
              </button>
            </div>
          </div>

          <div class="doc-body" id="docBody">
            <div class="kpi">
              <div class="box">
                <div class="label">Document</div>
                <div class="value" id="docTitle">‚Äî</div>
              </div>
              <div class="box">
                <div class="label">Statut</div>
                <div class="value" id="docStatus">En attente</div>
              </div>
              <div class="box">
                <div class="label">Pages</div>
                <div class="value" id="docPages">‚Äî</div>
              </div>
              <div class="box">
                <div class="label">DocID</div>
                <div class="value" id="docId">‚Äî</div>
              </div>
            </div>

            <div class="analysis-card mt-3">
              <div class="d-flex justify-content-between align-items-center">
                <h6><i class="bi bi-journal-text"></i> R√©sum√© ex√©cutif</h6>
                <span class="chip" id="topicsChip">0 th√®mes</span>
              </div>
              <div class="tiny mt-2" id="docSummary">D√©posez un PDF pour g√©n√©rer un r√©sum√© et activer les analyses multi-personas.</div>
            </div>

            <div id="analysisArea" class="mt-2"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- FOOTER INGESTION ZONE -->
    <div class="footerbar">
      <div class="dropzone" id="dropzone">
        <div class="d-flex align-items-center gap-3 flex-wrap">
          <div class="d-flex align-items-center gap-2">
            <div class="avatar" style="width:44px;height:44px;border-radius:16px;">
              <span>üì•</span>
            </div>
            <div>
              <div class="fw-bold">Ingestion PDF</div>
              <div class="tiny">Glissez-d√©posez un PDF ici, ou cliquez pour s√©lectionner. Le Cabinet IA se d√©clenche ensuite.</div>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <input type="file" id="pdfInput" accept="application/pdf" hidden />
            <button class="btn btn-soft" id="btnPick"><i class="bi bi-upload"></i> Choisir PDF</button>
            <button class="btn btn-soft" id="btnIngest" disabled><i class="bi bi-cpu"></i> Ingest</button>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3" style="min-width: 320px;">
          <div class="w-100">
            <div class="d-flex justify-content-between tiny mb-1">
              <span id="fileName">Aucun fichier</span>
              <span id="fileSize">‚Äî</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-success" id="progBar"></div>
            </div>
          </div>
          <span class="chip" id="ingestMode">API</span>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ----------------------------
    // State (NO DEMO)
    // ----------------------------
    const state = {
      docId: null,
      docTitle: null,
      docPages: null,
      topics: [],
      selectedPersonaId: "<%= personas[0]?.id || 'pm' %>",
      file: null
    };

    const personas = <%- JSON.stringify(personas) %>;

    // ‚úÖ SAFE: always hit same origin (correct host:port)
    const API_BASE = window.location.origin;

    // ----------------------------
    // DOM
    // ----------------------------
    const personaList   = document.getElementById("personaList");
    const modeChip      = document.getElementById("modeChip");
    const docChip       = document.getElementById("docChip");
    const personaMode   = document.getElementById("personaMode");

    const chatWrap      = document.getElementById("chatWrap");
    const chatInput     = document.getElementById("chatInput");
    const btnSend       = document.getElementById("btnSend");

    const pdfInput      = document.getElementById("pdfInput");
    const btnPick       = document.getElementById("btnPick");
    const btnIngest     = document.getElementById("btnIngest");
    const dropzone      = document.getElementById("dropzone");
    const fileName      = document.getElementById("fileName");
    const fileSize      = document.getElementById("fileSize");
    const progBar       = document.getElementById("progBar");

    const docTitleEl    = document.getElementById("docTitle");
    const docStatusEl   = document.getElementById("docStatus");
    const docPagesEl    = document.getElementById("docPages");
    const docIdEl       = document.getElementById("docId");
    const docSummaryEl  = document.getElementById("docSummary");
    const topicsChip    = document.getElementById("topicsChip");
    const analysisArea  = document.getElementById("analysisArea");
    const statusLine    = document.getElementById("statusLine");

    const btnAnalyzeAll = document.getElementById("btnAnalyzeAll");
    const btnSummarize  = document.getElementById("btnSummarize");
    const btnClear      = document.getElementById("btnClear");
    const btnExport     = document.getElementById("btnExport");

    // Status LEDs
    const ledApi      = document.getElementById("ledApi");
    const ledOllama   = document.getElementById("ledOllama");
    const ledAidesk   = document.getElementById("ledAidesk");
    const ledFirewall = document.getElementById("ledFirewall");

    // ----------------------------
    // Helpers
    // ----------------------------
    function fmtBytes(bytes){
      if(!bytes && bytes !== 0) return "‚Äî";
      const units = ["B","KB","MB","GB"];
      let i=0, n=bytes;
      while(n>=1024 && i<units.length-1){ n/=1024; i++; }
      return `${n.toFixed(i?1:0)} ${units[i]}`;
    }

    function setStatus(text, busy=false){
      statusLine.innerHTML = busy ? `<span class="blink">‚óè</span> ${text}` : `‚óè ${text}`;
    }

    function scrollChatToBottom(){
      chatWrap.scrollTop = chatWrap.scrollHeight;
    }

    function personaById(id){ return personas.find(p=>p.id===id) || personas[0]; }

    function renderPersonaSelection(){
      [...personaList.querySelectorAll(".persona-card")].forEach(card=>{
        card.classList.toggle("active", card.dataset.personaId === state.selectedPersonaId);
      });
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      })[m]);
    }

    function addMessage({from="me", text="", personaId=null}){
      const p = personaId ? personaById(personaId) : null;
      const isMe = from === "me";
      const who = isMe ? "<%= userName %>" : (p ? p.name : "GouvBrain");

      const msg = document.createElement("div");
      msg.className = "msg" + (isMe ? " me" : "");
      msg.innerHTML = `
        ${isMe ? "" : `
          <div class="avatar" style="width:38px;height:38px;border-radius:14px; box-shadow: 0 0 24px ${(p?.color||"#3b82f6")}33;">
            <span>${p?.avatarEmoji || "üß†"}</span>
          </div>
        `}
        <div style="${isMe ? "max-width:78%;" : ""}">
          <div class="who">${who} ${p ? `<span class="chip">${escapeHtml(p.ministry)}</span>` : `<span class="chip">syst√®me</span>`}</div>
          <div class="bubble">${escapeHtml(text)}</div>
        </div>
      `;
      chatWrap.appendChild(msg);
      scrollChatToBottom();
    }

    function setDocMeta({docId, title, pages, status, summary, topics=[]}){
      state.docId = docId ?? state.docId;
      state.docTitle = title ?? state.docTitle;
      state.docPages = (pages ?? state.docPages);
      state.topics = Array.isArray(topics) ? topics : (state.topics || []);

      docIdEl.textContent = state.docId || "‚Äî";
      docTitleEl.textContent = state.docTitle || "‚Äî";
      docPagesEl.textContent = (state.docPages ?? "‚Äî");
      docStatusEl.textContent = status || "Pr√™t";

      docChip.textContent = state.docId ? "Document charg√©" : "Aucun document";

      topicsChip.textContent = `${(state.topics || []).length} th√®mes`;
      if (typeof summary === "string" && summary.trim().length) docSummaryEl.textContent = summary;
    }

    function renderAnalyses(analyses){
      analysisArea.innerHTML = "";
      (analyses || []).forEach(a=>{
        const p = personaById(a.personaId);
        const card = document.createElement("div");
        card.className = "analysis-card";
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 style="margin-bottom:6px;"><span style="filter: drop-shadow(0 0 18px ${p.color}55);">${p.avatarEmoji||"ü§ñ"}</span> ${escapeHtml(p.name)}</h6>
              <div class="stance">
                <span style="width:10px;height:10px;border-radius:999px;background:${p.color}; box-shadow:0 0 18px ${p.color}88;"></span>
                <span>${escapeHtml(a.stance || "Perspective & recommandations")}</span>
              </div>
            </div>
            <span class="chip"><i class="bi bi-briefcase"></i> ${escapeHtml(p.ministry)}</span>
          </div>

          ${a.notes ? `<div class="tiny mb-2">${escapeHtml(a.notes)}</div>` : ""}

          <div class="row g-2">
            <div class="col-12">
              <div class="tiny fw-semibold mb-1"><i class="bi bi-exclamation-triangle"></i> Risques</div>
              <ul>${(a.risks||[]).slice(0,8).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>Aucun risque majeur identifi√©</li>"}</ul>
            </div>
            <div class="col-12 mt-2">
              <div class="tiny fw-semibold mb-1"><i class="bi bi-check2-circle"></i> Actions recommand√©es</div>
              <ul>${(a.actions||[]).slice(0,8).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>Proposer un plan d‚Äôaction</li>"}</ul>
            </div>
          </div>
        `;
        analysisArea.appendChild(card);
      });
    }

    function setLed(el, status){
      el.classList.remove("ok","warn","bad");
      if(status === "ok") el.classList.add("ok");
      else if(status === "warn") el.classList.add("warn");
      else if(status === "bad") el.classList.add("bad");
    }

    async function safeFetchJson(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        const err = new Error(`HTTP ${res.status} on ${url}`);
        err.status = res.status;
        err.body = txt;
        throw err;
      }
      return await res.json();
    }

    // ----------------------------
    // Real API calls (SAFE)
    // ----------------------------
    async function apiIngest(file){
      const fd = new FormData();
      fd.append("<%= process.env.INGEST_FORM_FIELD || 'file' %>", file);
      return await safeFetchJson(`${API_BASE}/api/gouvbrain/ingest`, { method:"POST", body: fd });
    }

    // ‚úÖ SAFE: chat goes to /api/ollama/chat (your running server)
    async function apiChat(_docId, message, personaModeVal, personaId){
      const p = (personaModeVal === "single" && personaId) ? personaById(personaId) : null;

      const system = p
        ? `Tu es ${p.name}, ${p.role} au minist√®re ${p.ministry}. Focus: ${p.focus}. R√©ponds en sections: Risques, Actions, D√©cision.`
        : `Tu es le Cabinet IA du Gouvernement. R√©ponds avec arbitrages, risques, actions, d√©cisions. Format: Risques, Actions, D√©cision.`;

      const payload = {
        model: "llama3.1:8b",
        stream: false,
        messages: [
          { role: "system", content: system },
          { role: "user", content: message }
        ]
      };

      return await safeFetchJson(`${API_BASE}/api/ollama/chat`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
    }

    // ‚úÖ SAFE: Export not implemented -> clean message (no fake downloads)
    async function apiExport(_docId){
      const err = new Error("Export non impl√©ment√© c√¥t√© serveur");
      err.status = 501;
      throw err;
    }

    // ----------------------------
    // Live Status Lights (NO MOCK)
    // ----------------------------
    async function pollHealth(){
      // API (main)
      try{
        await fetch(`${API_BASE}/api/health`, { method:"GET" });
        setLed(ledApi, "ok");
      }catch(e){
        setLed(ledApi, "bad");
      }

      // Ollama
      try{
        await fetch(`${API_BASE}/api/ollama/health`, { method:"GET" });
        setLed(ledOllama, "ok");
      }catch(e){
        setLed(ledOllama, "bad");
      }

      // Aidesk
      try{
        await fetch(`${API_BASE}/api/aidesk/health`, { method:"GET" });
        setLed(ledAidesk, "ok");
      }catch(e){
        setLed(ledAidesk, "bad");
      }

      // Firewall
      try{
        await fetch(`${API_BASE}/api/firewall-stats`, { method:"GET" });
        setLed(ledFirewall, "ok");
      }catch(e){
        setLed(ledFirewall, "bad");
      }
    }

    // ----------------------------
    // UI interactions
    // ----------------------------
    personaList.addEventListener("click", (e)=>{
      const card = e.target.closest(".persona-card");
      if(!card) return;
      state.selectedPersonaId = card.dataset.personaId;
      renderPersonaSelection();

      if (personaMode.value === "single"){
        const p = personaById(state.selectedPersonaId);
        modeChip.textContent = `Mode: ${p.name}`;
      }
    });

    personaMode.addEventListener("change", ()=>{
      if(personaMode.value === "cabinet"){
        modeChip.textContent = "Mode: Cabinet";
      }else{
        const p = personaById(state.selectedPersonaId);
        modeChip.textContent = `Mode: ${p.name}`;
      }
    });

    btnPick.addEventListener("click", ()=> pdfInput.click());

    pdfInput.addEventListener("change", ()=>{
      if(!pdfInput.files || !pdfInput.files[0]) return;
      setSelectedFile(pdfInput.files[0]);
    });

    function setSelectedFile(file){
      if(!file) return;
      if(file.type !== "application/pdf"){
        addMessage({from:"ai", text:"‚ö†Ô∏è Veuillez s√©lectionner un fichier PDF (application/pdf)."});
        return;
      }
      state.file = file;
      fileName.textContent = file.name;
      fileSize.textContent = fmtBytes(file.size);
      btnIngest.disabled = false;
      progBar.style.width = "0%";
      setStatus("Fichier pr√™t ‚Äî cliquez Ingest", false);
    }

    // Drag/drop
    ["dragenter","dragover"].forEach(ev=>{
      dropzone.addEventListener(ev, (e)=>{
        e.preventDefault();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(ev=>{
      dropzone.addEventListener(ev, (e)=>{
        e.preventDefault();
        dropzone.classList.remove("dragover");
      });
    });
    dropzone.addEventListener("drop", (e)=>{
      const file = e.dataTransfer.files?.[0];
      if(file) setSelectedFile(file);
    });
    dropzone.addEventListener("click", (e)=>{
      if(e.target.closest("button")) return;
      pdfInput.click();
    });

    btnIngest.addEventListener("click", async ()=>{
      if(!state.file) return;

      setStatus("Ingestion du PDF‚Ä¶", true);
      docStatusEl.textContent = "Ingestion‚Ä¶";
      progBar.style.width = "18%";

      try{
        const ingest = await apiIngest(state.file);
        progBar.style.width = "60%";

        setDocMeta({
          docId: ingest.docId,
          title: ingest.title || state.file.name,
          pages: ingest.pages,
          status: "Ingest√©",
          summary: ingest.summary,
          topics: ingest.keyTopics || []
        });

        addMessage({from:"ai", text:`‚úÖ Document ing√©r√©: ${ingest.title || state.file.name} (${ingest.pages ?? "?"} pages). Lancement de l‚Äôanalyse‚Ä¶`});
        progBar.style.width = "80%";

        // Auto-run analysis after ingestion (client-side)
        await runAnalyzeAll();

        progBar.style.width = "100%";
        setTimeout(()=> progBar.style.width = "0%", 900);
        setStatus("Pr√™t", false);
      }catch(err){
        console.error(err);
        docStatusEl.textContent = "Erreur";
        addMessage({from:"ai", text:`‚ùå √âchec ingestion. Endpoint /api/gouvbrain/ingest indisponible ou erreur serveur. (${err.message})`});
        setStatus("Erreur ingestion", false);
        progBar.style.width = "0%";
      }
    });

    // ‚úÖ SAFE: Analyze All runs client-side using /api/ollama/chat
    async function runAnalyzeAll(){
      // Allow analysis even without docId (but warn)
      if(!state.docId){
        addMessage({from:"ai", text:"‚ÑπÔ∏è DocID absent. Je lance quand m√™me une analyse g√©n√©rale (sans r√©f√©rence document)."});
      }

      setStatus("Analyse multi-personas‚Ä¶", true);
      docStatusEl.textContent = "Analyse‚Ä¶";
      analysisArea.innerHTML = "";

      const analyses = [];

      for (const p of personas){
        try{
          const q = "Analyse le dossier et propose: 6 risques, 6 actions, 1 d√©cision recommand√©e. R√©ponds en listes.";
          const out = await apiChat(state.docId, q, "single", p.id);

          const txt =
            out?.message?.content ||
            out?.response ||
            out?.text ||
            (Array.isArray(out?.messages) ? out.messages.map(m => m.text || m.content || "").join("\n") : "") ||
            "";

          const risksBlock = (txt.match(/Risques?:([\s\S]*?)(Actions?:|D√©cision:|Decision:|$)/i)?.[1] || "");
          const actionsBlock = (txt.match(/Actions?:([\s\S]*?)(D√©cision:|Decision:|$)/i)?.[1] || "");

          const risks = risksBlock.split("\n").map(s=>s.replace(/^[-‚Ä¢\d.)\s]+/,"").trim()).filter(Boolean).slice(0,8);
          const actions = actionsBlock.split("\n").map(s=>s.replace(/^[-‚Ä¢\d.)\s]+/,"").trim()).filter(Boolean).slice(0,8);

          analyses.push({
            personaId: p.id,
            stance: "Analyse",
            risks: risks.length ? risks : ["Voir notes (r√©ponse compl√®te)"],
            actions: actions.length ? actions : ["Voir notes (r√©ponse compl√®te)"],
            notes: txt
          });
        }catch(e){
          analyses.push({ personaId: p.id, stance:"Erreur", risks:[], actions:[], notes:`Erreur: ${e.message}` });
        }
      }

      renderAnalyses(analyses);
      docStatusEl.textContent = "Analyse pr√™te";
      addMessage({from:"ai", text:"üßæ Analyses g√©n√©r√©es (client-side). Posez vos questions dans le chat pour arbitrages & plan d‚Äôaction."});
      setStatus("Pr√™t", false);
    }

    btnAnalyzeAll.addEventListener("click", runAnalyzeAll);

    btnSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") sendChat();
    });

    // ‚úÖ SAFE: sendChat reads Ollama response shapes
    async function sendChat(){
      const text = (chatInput.value || "").trim();
      if(!text) return;

      addMessage({from:"me", text});
      chatInput.value = "";
      setStatus("Cabinet IA en r√©flexion‚Ä¶", true);

      const mode = personaMode.value;
      const personaId = (mode === "single") ? state.selectedPersonaId : null;

      try{
        const payload = await apiChat(state.docId, text, mode, personaId);

        const answer =
          payload?.message?.content ||
          payload?.response ||
          payload?.text ||
          (Array.isArray(payload?.messages) ? payload.messages.map(m => m.text || m.content || "").join("\n") : null);

        addMessage({from:"ai", personaId: personaId || null, text: answer || JSON.stringify(payload, null, 2)});
        setStatus("Pr√™t", false);
      }catch(err){
        console.error(err);
        addMessage({from:"ai", text:`‚ùå Chat API indisponible. V√©rifiez /api/ollama/chat. (${err.message})`});
        setStatus("Erreur chat", false);
      }
    }

    // ‚úÖ SAFE: Summarize uses chat (no /api/gouvbrain/doc/:docId dependency)
    btnSummarize.addEventListener("click", async ()=>{
      if(!state.docId){
        addMessage({from:"ai", text:"‚ÑπÔ∏è Pas de DocID: je peux r√©sumer √† partir de votre demande, mais l‚Äôingestion PDF est recommand√©e."});
      }

      setStatus("R√©sum√© ex√©cutif‚Ä¶", true);
      try{
        const payload = await apiChat(state.docId, "G√©n√®re un r√©sum√© ex√©cutif (10 lignes) + 6 th√®mes + 6 d√©cisions propos√©es.", "cabinet", null);
        const answer =
          payload?.message?.content ||
          payload?.response ||
          payload?.text ||
          (Array.isArray(payload?.messages) ? payload.messages.map(m => m.text || m.content || "").join("\n") : "");

        // Push into right panel summary field for convenience
        if (answer && typeof answer === "string") {
          docSummaryEl.textContent = answer;
        }
        addMessage({from:"ai", text:"üìå R√©sum√© ex√©cutif mis √† jour."});
        setStatus("Pr√™t", false);
      }catch(err){
        console.error(err);
        addMessage({from:"ai", text:`‚ùå Impossible de g√©n√©rer le r√©sum√© via /api/ollama/chat. (${err.message})`});
        setStatus("Erreur r√©sum√©", false);
      }
    });

    // ‚úÖ SAFE: Export disabled unless you implement a real endpoint later
    btnExport.addEventListener("click", async ()=>{
      addMessage({from:"ai", text:"‚ÑπÔ∏è Export non disponible pour l‚Äôinstant (aucun endpoint serveur). Impl√©mentez /api/gouvbrain/export si n√©cessaire."});
    });

    btnClear.addEventListener("click", ()=>{
      state.docId = null; state.docTitle = null; state.docPages = null; state.topics = [];
      state.file = null;

      pdfInput.value = "";
      fileName.textContent = "Aucun fichier";
      fileSize.textContent = "‚Äî";
      btnIngest.disabled = true;
      progBar.style.width = "0%";

      setDocMeta({
        docId:null,
        title:null,
        pages:null,
        status:"En attente",
        summary:"D√©posez un PDF pour g√©n√©rer un r√©sum√© et activer les analyses multi-personas.",
        topics:[]
      });
      analysisArea.innerHTML = "";
      docChip.textContent = "Aucun document";

      // keep first system message only
      const keep = chatWrap.querySelector(".msg");
      chatWrap.innerHTML = "";
      if(keep) chatWrap.appendChild(keep);

      addMessage({from:"ai", text:"‚ôªÔ∏è Session r√©initialis√©e. D√©posez un nouveau PDF."});
      setStatus("Pr√™t", false);
    });

    // ----------------------------
    // Init
    // ----------------------------
    function init(){
      renderPersonaSelection();
      setDocMeta({docId:null, title:null, pages:null, status:"En attente"});
      setStatus("Pr√™t", false);

      // Health polling
      pollHealth();
      setInterval(pollHealth, 7000);
    }
    init();
  </script>
</body>
</html>