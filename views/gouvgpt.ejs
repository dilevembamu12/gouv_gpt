<!-- 
  GouvBrain Frontend - Mode Orchestrateur Unique
-->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GouvBrain ‚Ä¢ Conseil des Ministres IA</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    :root { 
        --bg-body: #09090b; --bg-sidebar: #0f1016; --bg-surface: #18181b; --text-primary: #f4f4f5; 
        --accent-primary: #3b82f6; --font-main: 'Plus Jakarta Sans', sans-serif;
    }
    body { background-color: var(--bg-body); color: var(--text-primary); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    .chat-area { flex: 1; overflow-y: auto; background: radial-gradient(circle at 50% -20%, #172554 0%, var(--bg-body) 60%); padding: 2rem 15%; display: flex; flex-direction: column; gap: 1.5rem; }
    .sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid #27272a; display: flex; flex-direction: column; }
    
    .input-container { max-width: 800px; margin: 0 auto; width: 100%; padding-bottom: 2rem; position: sticky; bottom: 0; }
    .input-box { background: var(--bg-surface); border: 1px solid #27272a; border-radius: 16px; padding: 0.8rem; display: flex; gap: 0.5rem; align-items: flex-end; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
    textarea { background: transparent; border: none; color: white; width: 100%; resize: none; outline: none; font-family: inherit; }
    
    .msg { display: flex; gap: 1rem; animation: slideIn 0.3s ease; }
    .msg.me { flex-direction: row-reverse; }
    .msg-content { padding: 1rem 1.25rem; border-radius: 16px; line-height: 1.6; position: relative; max-width: 80%; }
    .msg.bot .msg-content { background: var(--bg-surface); border: 1px solid #27272a; color: #e2e8f0; border-top-left-radius: 4px; }
    .msg.me .msg-content { background: var(--accent-primary); color: white; border-top-right-radius: 4px; }
    .avatar { width: 36px; height: 36px; border-radius: 8px; background: #27272a; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    
    .thinking-dots::after { content: ' .'; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body>

  <!-- MODAL -->
  <div class="modal fade" id="roomModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="background: #18181b; border: 1px solid #3f3f46; color: white;">
        <div class="modal-header border-0"><h4><i class="bi bi-cpu me-2"></i>Configuration Conseil IA</h4></div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="text-secondary small fw-bold mb-1">SUJET</label>
                <input type="text" id="roomNameInput" class="form-control bg-dark text-white border-secondary" placeholder="ex: Projet de Loi Finances">
            </div>
            <label class="text-secondary small fw-bold mb-2">PARTICIPANTS</label>
            <div class="row g-2" id="personaSelector"></div>
        </div>
        <div class="modal-footer border-0">
            <button class="btn btn-primary w-100 fw-bold" onclick="createRoom()">Ouvrir la Session</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="appShell" class="d-flex h-100" style="opacity:0; pointer-events:none; transition: opacity 0.5s;">
    <!-- SIDEBAR -->
    <div class="sidebar p-3">
        <div class="mb-4">
            <h5 class="fw-bold text-white mb-0">GouvBrain</h5>
            <div class="small text-secondary" id="roomTitleDisplay">Chargement...</div>
        </div>
        <h6 class="text-secondary small fw-bold text-uppercase mb-3">Cabinet Actif</h6>
        <div id="activePersonasCol" class="d-flex flex-column gap-2 overflow-auto"></div>
    </div>

    <!-- CHAT -->
    <div style="flex:1; display:flex; flex-direction:column; position:relative;">
        <div id="chatWrap" class="chat-area">
            <div class="text-center text-muted mt-5">
                <i class="bi bi-stars fs-1 mb-3 d-block"></i>
                <h3>Le conseil est ouvert</h3>
                <p>Posez une question. L'orchestrateur distribuera la parole.</p>
            </div>
        </div>

        <div class="input-container">
            <div class="text-center small text-secondary mb-2" id="statusIndicator"></div>
            <div class="input-box">
                <input type="file" id="ragInput" hidden onchange="uploadRag()">
                <button class="btn btn-link text-secondary" onclick="document.getElementById('ragInput').click()"><i class="bi bi-paperclip fs-5"></i></button>
                <textarea id="chatInput" rows="1" placeholder="Question aux minist√®res..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <button class="btn btn-primary btn-sm px-3" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentRoomId = null;
    let allPersonas = [];
    let activePersonas = [];

    // --- INIT ---
    async function init() {
        const res = await fetch('/api/admin/personas');
        const data = await res.json();
        allPersonas = data.personas;

        document.getElementById('personaSelector').innerHTML = allPersonas.map(p => `
            <div class="col-md-6">
                <div class="form-check bg-black bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                    <input class="form-check-input" type="checkbox" value="${p.id}" id="p_${p.id}" checked>
                    <label class="form-check-label d-flex align-items-center gap-2" for="p_${p.id}">
                        <span class="fs-4">${p.avatarEmoji}</span>
                        <div>
                            <div class="fw-bold text-white">${p.ministry}</div>
                            <div class="small text-secondary">${p.name}</div>
                        </div>
                    </label>
                </div>
            </div>
        `).join('');
        new bootstrap.Modal(document.getElementById('roomModal')).show();
    }

    // --- CREATE ROOM ---
    async function createRoom() {
        const name = document.getElementById('roomNameInput').value;
        const ids = [...document.querySelectorAll('#personaSelector input:checked')].map(c => c.value);
        
        const res = await fetch('/api/rooms', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name, selectedPersonaIds: ids })
        });
        const data = await res.json();
        
        if(data.ok){
            currentRoomId = data.room.id;
            activePersonas = allPersonas.filter(p => ids.includes(p.id));
            document.getElementById('roomTitleDisplay').innerText = data.room.name;
            renderSidebar();
            
            document.querySelector('.modal.show').classList.remove('show');
            document.querySelector('.modal-backdrop').remove();
            document.getElementById('roomModal').style.display = 'none';
            document.getElementById('appShell').style.opacity = 1;
            document.getElementById('appShell').style.pointerEvents = 'all';
        }
    }

    function renderSidebar(){
        document.getElementById('activePersonasCol').innerHTML = activePersonas.map(p => `
            <div class="d-flex align-items-center gap-2 p-2 rounded bg-white bg-opacity-5">
                <div class="avatar bg-transparent">${p.avatarEmoji}</div>
                <div class="overflow-hidden">
                    <div class="fw-bold small text-white text-truncate">${p.ministry}</div>
                </div>
            </div>
        `).join('');
    }

    // --- UPLOAD ---
    async function uploadRag(){
        const file = document.getElementById('ragInput').files[0];
        if(!file) return;
        const status = document.getElementById('statusIndicator');
        status.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Envoi au secr√©tariat...`;
        
        const fd = new FormData(); fd.append('file', file);
        const res = await fetch(`/api/rooms/${currentRoomId}/ingest`, {method:'POST', body:fd});
        const d = await res.json();
        
        if(d.ok) {
            status.innerText = "Document class√©.";
            addMessage("system", `üìÇ <strong>${file.name}</strong> a √©t√© ajout√© au dossier.`);
        } else {
            status.innerText = "Erreur.";
            alert(d.error);
        }
    }

    // --- CHAT ORCHESTR√â ---
    async function sendMessage(){
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;

        input.value = '';
        input.style.height = 'auto';

        // 1. Mon message
        addMessage("me", text);

        // 2. Appel Unique
        const status = document.getElementById('statusIndicator');
        status.innerHTML = `<span class="thinking-dots">Consultation des minist√®res</span>`;

        try {
            const res = await fetch('/api/chat/n8n', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ roomId: currentRoomId, message: text })
            });

            const backendRes = await res.json();

            if (backendRes.ok) {
                const data = backendRes.data;
                // n8n renvoie { responses: [ { ministry: "...", text: "..." } ] }
                if (data.responses && Array.isArray(data.responses)) {
                    data.responses.forEach(r => {
                        // Trouver l'emoji correspondant
                        const p = activePersonas.find(ap => ap.ministry === r.ministry);
                        addMessage("bot", r.text, { 
                            name: r.ministry, 
                            avatar: p ? p.avatarEmoji : "üèõÔ∏è" 
                        });
                    });
                } else if (data.response) {
                    // Fallback texte simple
                    addMessage("bot", data.response, { name: "Secr√©tariat", avatar: "üìù" });
                }
            } else {
                throw new Error(backendRes.error);
            }
        } catch (e) {
            addMessage("system", `Erreur technique : ${e.message}`);
        } finally {
            status.innerHTML = '';
        }
    }

    function addMessage(type, text, meta = {}) {
        const wrap = document.getElementById('chatWrap');
        if(wrap.querySelector('.text-center.text-muted')) wrap.innerHTML = ''; // Clear empty state

        const div = document.createElement('div');
        div.className = `msg ${type}`;
        
        let content = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        if(type === 'me') {
            div.innerHTML = `<div class="msg-content">${content}</div>`;
        } else if(type === 'system') {
            div.className = "text-center my-3 small text-secondary opacity-75";
            div.innerHTML = content;
        } else {
            // Bot message with Avatar
            div.innerHTML = `
                <div class="avatar">${meta.avatar || 'ü§ñ'}</div>
                <div style="max-width:85%">
                    <div class="small fw-bold text-secondary mb-1 ms-1">${meta.name || 'IA'}</div>
                    <div class="msg-content">${content}</div>
                </div>
            `;
        }
        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
    }

    document.getElementById('chatInput').addEventListener('keypress', e => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    init();
  </script>
</body>
</html>