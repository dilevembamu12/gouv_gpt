<!doctype html>
<html lang="fr" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>GouvBrain â€¢ Orchestrateur</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  
  <!-- Markdown Parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    :root {
        --c-bg-body: #050505;
        --c-bg-sidebar: #0a0a0a;
        --c-bg-card: #121212;
        --c-bg-input: #161616;
        --c-bg-bubble-bot: #181818;
        --c-bg-bubble-user: #006fee;
        --c-border: #262626;
        --c-text-primary: #ffffff;
        --c-text-secondary: #a1a1aa;
        --c-text-tertiary: #71717a;
        --r-radius-lg: 20px;
        --r-radius-md: 14px;
        --font-sans: 'Inter', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
        --chat-pad-bottom: 260px;
    }

    body { background-color: var(--c-bg-body); color: var(--c-text-primary); font-family: var(--font-sans); height: 100vh; overflow: hidden; display: flex; font-size: 14.5px; -webkit-font-smoothing: antialiased; }
    
    /* --- LAYOUT --- */
    .app-sidebar, .app-inspector { background-color: var(--c-bg-sidebar); display: flex; flex-direction: column; z-index: 100; flex-shrink: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .app-sidebar { width: 280px; border-right: 1px solid var(--c-border); padding: 16px; }
    .app-inspector { width: 320px; border-left: 1px solid var(--c-border); position: relative; }
    .app-inspector.collapsed { width: 0; border-left: none; }
    
    .app-main { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; background: radial-gradient(circle at 50% 0%, #111 0%, #050505 100%); }

    /* --- SIDEBARS --- */
    .brand-area { display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--c-border); }
    .brand-logo { width: 34px; height: 34px; background: linear-gradient(135deg, #006fee 0%, #00c6f7 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 18px; }
    
    .sidebar-section-title { font-size: 11px; font-weight: 700; color: var(--c-text-tertiary); text-transform: uppercase; margin: 20px 8px 10px; letter-spacing: 0.5px; }
    .room-item { padding: 10px 12px; border-radius: 10px; cursor: pointer; color: var(--c-text-secondary); transition: 0.2s; font-size: 13.5px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid transparent; }
    .room-item:hover { background: var(--c-bg-card); color: white; }
    .room-item.active { background: rgba(0, 111, 238, 0.12); color: #006fee; border-color: rgba(0, 111, 238, 0.25); font-weight: 500; }

    .persona-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 10px; transition: 0.2s; font-size: 13px; color: var(--c-text-secondary); }
    .persona-avatar { width: 30px; height: 30px; border-radius: 8px; background: var(--c-bg-card); display: flex; align-items: center; justify-content: center; font-size: 16px; border: 1px solid var(--c-border); }

    /* --- CHAT AREA --- */
    .chat-header { height: 64px; display: flex; align-items: center; justify-content: space-between; padding: 0 24px; border-bottom: 1px solid var(--c-border); backdrop-filter: blur(15px); background: rgba(5,5,5,0.7); z-index: 10; }
    .chat-content { flex: 1; overflow-y: auto; padding: 24px 20px 40px; display: flex; flex-direction: column; gap: 32px; scroll-behavior: smooth; }
    .chat-content::-webkit-scrollbar { width: 5px; }
    .chat-content::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

    .chat-bottom-spacer { height: var(--chat-pad-bottom); flex-shrink: 0; pointer-events: none; }

    /* --- MESSAGE ROWS --- */
    .message-row { display: flex; gap: 16px; max-width: 850px; margin: 0 auto; width: 100%; animation: fadeIn 0.3s ease; position: relative; }
    .message-row.me { flex-direction: row-reverse; }
    .message-row.sub-message { margin-left: auto; padding-left: 48px; max-width: 800px; }
    .message-row.sub-message::before { content: ''; position: absolute; left: 24px; top: -32px; bottom: 40px; width: 2px; background: var(--c-border); border-radius: 0 0 0 10px; }

    .message-avatar-large { width: 42px; height: 42px; border-radius: 14px; background: var(--c-bg-card); border: 1px solid var(--c-border); display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .message-bubble-container { display: flex; flex-direction: column; max-width: 85%; min-width: 0; }
    .message-row.me .message-bubble-container { align-items: flex-end; }
    .message-sender { font-size: 12px; color: var(--c-text-tertiary); margin-bottom: 6px; font-weight: 600; padding: 0 4px; }

    .message-bubble { padding: 16px 20px; border-radius: 20px; line-height: 1.6; font-size: 15px; position: relative; }
    .message-row.bot .message-bubble { background: var(--c-bg-bubble-bot); border: 1px solid var(--c-border); border-top-left-radius: 4px; color: #e4e4e7; }
    .message-row.synthesis .message-bubble { background: linear-gradient(145deg, #18181b 0%, #09090b 100%); border: 1px solid #333; border-top-left-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
    .message-row.synthesis .message-bubble::after { content: "SYNTHÃˆSE"; position: absolute; top: -10px; right: 20px; font-size: 9px; font-weight: 800; background: #006fee; color: white; padding: 2px 8px; border-radius: 4px; letter-spacing: 0.5px; }
    .message-row.me .message-bubble { background: var(--c-bg-bubble-user); color: white; border-top-right-radius: 4px; background-image: linear-gradient(135deg, #006fee 0%, #005bc4 100%); }

    /* --- MARKDOWN STYLES --- */
    .message-bubble p { margin-bottom: 12px; }
    .message-bubble p:last-child { margin-bottom: 0; }
    .message-bubble ul, .message-bubble ol { padding-left: 20px; margin-bottom: 12px; }
    .message-bubble li { margin-bottom: 4px; }
    .message-bubble strong { color: #fff; font-weight: 700; }
    .message-bubble code { font-family: var(--font-mono); background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
    .message-bubble pre { background: #000; padding: 14px; border-radius: 12px; border: 1px solid var(--c-border); overflow-x: auto; margin: 12px 0; }
    .message-bubble blockquote { border-left: 3px solid #006fee; padding-left: 16px; color: var(--c-text-secondary); font-style: italic; margin: 12px 0; }
    .message-bubble table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
    .message-bubble th, .message-bubble td { border: 1px solid var(--c-border); padding: 8px 12px; text-align: left; }
    .message-bubble th { background: rgba(255,255,255,0.05); color: #fff; }

    /* --- LOADING --- */
    .loading-container { display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: rgba(0, 111, 238, 0.05); border: 1px solid rgba(0, 111, 238, 0.1); border-radius: 16px; width: fit-content; animation: pulseLoading 2s infinite; margin-left: 60px; }
    @keyframes pulseLoading { 0%, 100% { opacity: 0.8; } 50% { opacity: 1; transform: translateY(-2px); } }
    .loading-spinner { width: 18px; height: 18px; border: 2px solid #006fee; border-top-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* --- ACTIONS --- */
    .message-actions { display: flex; gap: 8px; margin-top: 10px; opacity: 0; transform: translateY(-5px); transition: 0.2s ease; }
    .message-row:hover .message-actions { opacity: 1; transform: translateY(0); }
    .action-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: var(--c-text-secondary); border-radius: 8px; padding: 4px 10px; font-size: 11px; display: inline-flex; align-items:center; gap:6px; cursor:pointer; }
    .action-btn:hover { background: rgba(255,255,255,0.1); color: white; border-color: rgba(255,255,255,0.2); }

    /* --- RAG SOURCES --- */
    .rag-panel { margin-top: 16px; border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.2); border-radius: 14px; overflow: hidden; }
    .rag-panel summary { list-style: none; cursor: pointer; padding: 10px 14px; display: flex; align-items: center; justify-content: space-between; font-size: 12px; color: var(--c-text-secondary); font-weight: 600; }
    .rag-panel summary::-webkit-details-marker { display: none; }
    .rag-panel summary:hover { background: rgba(255,255,255,0.03); }
    .rag-list { padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; border-top: 1px solid rgba(255,255,255,0.05); }
    .rag-item { display: flex; gap: 10px; padding: 10px; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
    .rag-ico { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; background: rgba(255,82,82,0.1); color: #ff5252; flex-shrink: 0; }
    .score-tag { padding: 1px 5px; border-radius: 4px; font-weight: 700; font-size: 10px; }
    .score-high { background: rgba(34,197,94,0.1); color: #22c55e; }
    .score-med { background: rgba(234,179,8,0.1); color: #eab308; }
    .score-low { background: rgba(113,113,122,0.1); color: #a1a1aa; }

    /* --- INPUT AREA --- */
    .input-wrapper { position: absolute; bottom: 0; left: 0; right: 0; padding: 10px 20px 30px; background: linear-gradient(to top, var(--c-bg-body) 70%, transparent); z-index: 50; }
    .input-container { max-width: 850px; margin: 0 auto; background: var(--c-bg-input); border: 1px solid var(--c-border); border-radius: 22px; padding: 12px 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
    .input-container:focus-within { border-color: #006fee; }
    
    .persona-chipbar { display: flex; gap: 8px; overflow-x: auto; padding: 4px 4px 12px; margin-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .persona-chip { display: flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 99px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); font-size: 12px; color: var(--c-text-secondary); cursor: pointer; white-space: nowrap; transition: 0.2s; }
    .chat-rich-input { width: 100%; background: transparent; border: none; color: white; padding: 8px 4px; outline: none; max-height: 180px; min-height: 44px; font-size: 15px; line-height: 1.5; overflow-y: auto; }
    .chat-rich-input:empty:before { content: attr(data-placeholder); color: var(--c-text-tertiary); pointer-events: none; }
    .mention-tag { background: rgba(0, 111, 238, 0.2); color: #006fee; padding: 2px 6px; border-radius: 6px; font-weight: 600; border: 1px solid rgba(0, 111, 238, 0.3); margin: 0 2px; }

    .input-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; }
    .model-badge { display: flex; align-items: center; gap: 6px; font-size: 11px; font-family: var(--font-mono); color: var(--c-text-tertiary); background: rgba(255,255,255,0.03); padding: 4px 10px; border-radius: 8px; }

    .send-btn { width: 36px; height: 36px; border-radius: 12px; border: none; background: #006fee; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    
    .mention-menu { position: absolute; bottom: 100%; left: 16px; width: 260px; background: #1a1a1b; border: 1px solid var(--c-border); border-radius: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); display: none; overflow: hidden; margin-bottom: 12px; z-index: 1000; }
    .mention-menu.show { display: block; animation: slideUp 0.15s ease-out; }
    .mention-menu-item { padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.1s; font-size: 13px; }
    .mention-menu-item:hover, .mention-menu-item.selected { background: #262628; }
    .mention-menu-item.selected { border-left: 3px solid #006fee; }

    /* --- PROMPTS --- */
    .prompt-card { background: rgba(255,255,255,0.02); border: 1px solid var(--c-border); border-radius: 16px; padding: 16px; height: 100%; transition: 0.2s; cursor: pointer; }
    .prompt-card:hover { background: rgba(255,255,255,0.05); border-color: #006fee; transform: translateY(-3px); }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 768px) {
        .app-sidebar, .app-inspector { display: none; }
        .input-wrapper { padding: 10px; }
        :root { --chat-pad-bottom: 180px; }
    }
  </style>
</head>

<body>
  <!-- CONFIG MODAL -->
  <div class="modal fade" id="roomModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-bottom-0 pb-0"><h5 class="modal-title fw-bold">Nouvelle Session</h5></div>
        <div class="modal-body">
          <div class="mb-4">
            <label class="form-label small fw-bold text-tertiary">SUJET DU CONSEIL</label>
            <input type="text" class="form-control form-control-lg bg-dark border-secondary border-opacity-25" id="roomNameInput" placeholder="Analyse PLF 2026...">
          </div>
          <label class="form-label small fw-bold text-tertiary mb-3">EXPERTS Ã€ CONVOQUER</label>
          <div class="row g-2" id="personaSelector"></div>
        </div>
        <div class="modal-footer border-top-0 pt-0"><button class="btn btn-primary w-100 py-3 fw-bold rounded-4" onclick="createRoom()">Ouvrir le Dossier</button></div>
      </div>
    </div>
  </div>
  
  <!-- PROMPTS MODAL -->
  <div class="modal fade" id="promptModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content border-0 shadow-lg">
        <div class="modal-header border-0 pb-0 d-flex justify-content-between align-items-center p-4">
          <h5 class="fw-bold m-0"><i class="bi bi-stars text-warning me-2"></i>ModÃ¨les Gouvernementaux</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4 pt-2"><div class="row g-3" id="promptGrid"></div></div>
      </div>
    </div>
  </div>

  <aside class="app-sidebar">
    <div class="brand-area"><div class="brand-logo"><i class="bi bi-cpu-fill"></i></div><div class="fw-bold fs-5">GouvBrain</div></div>
    <div class="sidebar-section-title d-flex justify-content-between align-items-center"><span>Dossiers</span><i class="bi bi-plus-circle-fill text-primary cursor-pointer" style="font-size: 18px;" onclick="showNewRoomModal()"></i></div>
    <div id="roomList" class="flex-grow-1 overflow-auto"></div>
    <div class="sidebar-section-title">Cabinet Actif</div>
    <div id="activePersonasCol" class="d-flex flex-column gap-1 overflow-auto"></div>
  </aside>

  <main class="app-main">
    <header class="chat-header">
        <h6 class="m-0 fw-bold" id="headerRoomTitle">Dossier en attente...</h6>
        <div class="d-flex gap-2">
            <button class="action-btn" title="ParamÃ¨tres"><i class="bi bi-gear-fill"></i></button>
            <button class="action-btn" onclick="toggleInspector()"><i class="bi bi-layout-sidebar-reverse"></i></button>
        </div>
    </header>

    <div id="chatWrap" class="chat-content">
        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-center opacity-20 empty-state">
            <i class="bi bi-shield-lock-fill display-1 mb-4"></i>
            <h3>Orchestration SÃ©curisÃ©e</h3>
            <p>SÃ©lectionnez un dossier pour dÃ©marrer la sÃ©ance.</p>
        </div>
    </div>

    <div class="input-wrapper">
        <div id="statusIndicator"></div>
        <div class="input-container">
            <div id="mentionMenu" class="mention-menu"></div>
            <div class="persona-chipbar" id="personaChipbar"></div>
            <div class="input-header d-flex gap-2 mb-2">
                <button class="action-btn" onclick="document.getElementById('ragInput').click()"><i class="bi bi-paperclip"></i></button>
                <input type="file" id="ragInput" hidden onchange="uploadRag()">
                <button class="action-btn" onclick="openPromptLibrary()"><i class="bi bi-stars"></i></button>
                <button class="action-btn" onclick="clearChat()"><i class="bi bi-eraser"></i></button>
            </div>
            <div id="chatInput" class="chat-rich-input" contenteditable="true" data-placeholder="Posez votre question... (@ pour mentionner)"></div>
            <div class="input-footer">
                <div class="model-badge"><i class="bi bi-lightning-charge-fill text-success"></i> GPT-4o Enhanced</div>
                <button id="sendBtn" class="send-btn" onclick="sendMessage()"><i class="bi bi-arrow-up-short fs-4"></i></button>
            </div>
        </div>
        <div class="text-center mt-2 small text-tertiary opacity-40" style="font-size: 10px;">IA GOUVERNEMENTALE â€¢ BASÃ‰ SUR LES DONNÃ‰ES OFFICIELLES</div>
    </div>
  </main>

  <aside class="app-inspector collapsed" id="appInspector">
    <div class="chat-header"><span class="fw-bold small text-uppercase">Dossier SÃ©ance</span><button class="btn btn-sm text-tertiary p-0" onclick="toggleInspector()"><i class="bi bi-x-lg"></i></button></div>
    <div class="p-4">
        <label class="sidebar-section-title mt-0">Base de Connaissances</label>
        <div id="inspectorFileList" class="d-flex flex-column gap-2"></div>
        <label class="sidebar-section-title mt-5">Configuration RAG</label>
        <div class="p-3 rounded-4 bg-dark border border-secondary border-opacity-10"><div class="d-flex justify-content-between mb-3"><span class="small">Top-K Docs</span><span class="text-white small">5</span></div><div class="progress" style="height: 4px; background: #222;"><div class="progress-bar bg-primary" style="width: 50%"></div></div></div>
    </div>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentRoomId = null, allPersonas = [], activePersonas = [], isPolling = false, lastUserQuery = '', selectedMenuIndex = 0, lastSavedRange = null;

    // --- PROMPTS ---
    const PRESET_PROMPTS = [
        { icon: "ðŸ“œ", title: "Analyse LÃ©gale", text: "Quelles sont les dispositions du Journal Officiel concernant ce sujet ?", desc: "Recherche juridique." },
        { icon: "ðŸ’°", title: "Budget", text: "Quel est l'impact financier de cette mesure ?", desc: "Analyse budgÃ©taire." },
        { icon: "ðŸ“Š", title: "SynthÃ¨se", text: "Faites une synthÃ¨se des positions de chaque ministÃ¨re prÃ©sent.", desc: "RÃ©sumÃ© global." },
        { icon: "ðŸš¨", title: "Risques", text: "Identifiez les points de blocage ou les risques majeurs.", desc: "Ã‰tude d'impact." }
    ];

    // --- UTILS ---
    function fmtScore(x) { return typeof x === 'number' ? Math.round(x * 100) + '%' : 'N/A'; }
    function escapeHtml(str) { return String(str ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function scrollChatToBottom() { const wrap = document.getElementById('chatWrap'); wrap.scrollTop = wrap.scrollHeight; }

    // MARKDOWN CONFIG
    marked.setOptions({ gfm: true, breaks: true, sanitize: false });

    function buildRagPanel(sources = []) {
        if (!sources?.length) return '';
        const items = sources.map(s => {
            const score = s.relevance_score ?? s.score ?? 0;
            const cls = score > 0.6 ? 'score-high' : (score > 0.3 ? 'score-med' : 'score-low');
            return `<div class="rag-item"><div class="rag-ico"><i class="bi bi-file-earmark-text"></i></div><div class="overflow-hidden flex-grow-1"><div class="rag-filename" title="${escapeHtml(s.filename)}">${escapeHtml(s.filename)}</div><div class="rag-meta"><span>Page ${s.page ?? '?'}</span><span class="score-tag ${cls}">Score: ${fmtScore(score)}</span></div></div></div>`;
        }).join('');
        return `<details class="rag-panel"><summary><span><i class="bi bi-journal-text me-2"></i>Sources documentaires</span> <i class="bi bi-chevron-down small"></i></summary><div class="rag-list">${items}</div></details>`;
    }

    // --- LOGIQUE SALONS ---
    async function init() {
        const resP = await fetch('/api/admin/personas');
        const dataP = await resP.json();
        allPersonas = dataP.personas;
        document.getElementById('personaSelector').innerHTML = allPersonas.map(p => `<div class="col-6"><div class="form-check bg-dark p-3 rounded-4 border border-secondary border-opacity-10 h-100"><input class="form-check-input" type="checkbox" value="${p.id}" id="chk_${p.id}" checked><label class="form-check-label ms-2 text-white small" for="chk_${p.id}">${p.avatarEmoji} <strong>${p.ministry}</strong></label></div></div>`).join('');
        await refreshRoomList();
    }

    async function refreshRoomList() {
        const res = await fetch('/api/rooms'), data = await res.json();
        document.getElementById('roomList').innerHTML = data.rooms.map(r => `<div class="room-item ${currentRoomId === r.id ? 'active' : ''}" onclick="loadRoom('${r.id}')"><i class="bi bi-folder2 me-2"></i>${r.name}</div>`).join('');
        if(!currentRoomId && data.rooms.length > 0) loadRoom(data.rooms[0].id);
    }

    async function loadRoom(id) {
        currentRoomId = id;
        refreshRoomList();
        const res = await fetch(`/api/rooms/${id}`), data = await res.json(), room = data.room;
        document.getElementById('headerRoomTitle').innerText = room.name;
        activePersonas = allPersonas.filter(p => room.activePersonas.includes(p.id));
        renderPersonaChipbar();
        renderCabinetSidebar();
        const chatWrap = document.getElementById('chatWrap');
        chatWrap.innerHTML = '';
        if (room.messages?.length > 0) {
            room.messages.forEach(msg => {
                if (msg.role === 'user') addMessage('me', msg.content);
                else renderResponse(msg.content);
            });
        }
        const spacer = document.createElement('div'); spacer.className = 'chat-bottom-spacer'; chatWrap.appendChild(spacer);
        document.getElementById('inspectorFileList').innerHTML = (room.files?.length) ? room.files.map(f => `<div class="p-2 border border-secondary border-opacity-10 rounded-3 bg-dark small"><i class="bi bi-file-earmark me-2"></i>${f.name}</div>`).join('') : '<div class="text-center text-secondary small py-4 opacity-50 fst-italic">Aucun document joint</div>';
        scrollChatToBottom();
    }

    function renderPersonaChipbar() {
        document.getElementById('personaChipbar').innerHTML = activePersonas.map(p => `<div class="persona-chip" onmousedown="event.preventDefault(); saveCurrentRange();" onclick="insertMentionDirectly('${p.avatarEmoji}', '${p.ministry}')"><span>${p.avatarEmoji}</span> <span>${p.ministry}</span></div>`).join('');
    }

    function renderCabinetSidebar() {
        document.getElementById('activePersonasCol').innerHTML = activePersonas.map(p => `<div class="persona-item"><div class="persona-avatar">${p.avatarEmoji}</div><div class="text-truncate fw-bold">${p.ministry}</div></div>`).join('');
    }

    // --- CHAT ---
    async function sendMessage() {
        if(isPolling) return;
        const inputEl = document.getElementById('chatInput'), text = inputEl.innerText.trim();
        if(!text) return;
        lastUserQuery = text;
        inputEl.innerHTML = ''; 
        addMessage('me', text);
        showLoadingState();
        try {
            const res = await fetch('/api/chat/n8n', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({roomId:currentRoomId, message:text}) });
            const json = await res.json();
            if(json.ok && json.taskId) pollTask(json.taskId);
        } catch(e) { hideLoadingState(); document.getElementById('statusIndicator').innerHTML = '<span class="text-danger small">Erreur rÃ©seau</span>'; }
    }

    function showLoadingState() {
        document.getElementById('statusIndicator').innerHTML = `<div class="loading-container"><div class="loading-spinner"></div><div class="small fw-bold text-primary"><span id="loadingPhase">L'orchestrateur consulte les experts</span><span class="thinking-dots"></span></div></div>`;
        const phases = ["Analyse de la question", "Recherche dans le RAG", "Consultation des ministÃ¨res", "SynthÃ¨se du conseil"];
        let i = 0;
        window.loadingTimer = setInterval(() => { i = (i + 1) % phases.length; const el = document.getElementById('loadingPhase'); if(el) el.innerText = phases[i]; }, 3000);
    }

    function hideLoadingState() { clearInterval(window.loadingTimer); document.getElementById('statusIndicator').innerHTML = ''; }

    async function pollTask(taskId) {
        isPolling = true;
        const check = async () => {
            const res = await fetch(`/api/chat/task/${taskId}`), json = await res.json();
            if(json.status === 'completed') { isPolling = false; hideLoadingState(); renderResponse(json.data); }
            else if(json.status === 'error') { isPolling = false; hideLoadingState(); document.getElementById('statusIndicator').innerHTML = '<span class="text-danger small">Erreur critique n8n</span>'; }
            else setTimeout(check, 2000);
        };
        check();
    }

    function renderResponse(data) {
        const payload = data?.data ?? data, wrap = document.getElementById('chatWrap'), oldSpacer = wrap.querySelector('.chat-bottom-spacer');
        if(oldSpacer) oldSpacer.remove();
        if(payload.global_synthesis) addMessage('synthesis', payload.global_synthesis, {name:"SynthÃ¨se Gouvernementale", avatar:"ðŸ›ï¸"});
        if(Array.isArray(payload.responses)) payload.responses.forEach(r => addMessage('bot', r.text, {name:r.ministry_name, avatar:r.avatar_emoji, isSubItem:true}, r.rag_sources));
        const spacer = document.createElement('div'); spacer.className = 'chat-bottom-spacer'; wrap.appendChild(spacer);
        scrollChatToBottom();
    }

    function addMessage(type, text, meta={}, sources=[]) {
        const wrap = document.getElementById('chatWrap'), div = document.createElement('div'), isMe = type === 'me';
        div.className = `message-row ${isMe ? 'me' : (type === 'synthesis' ? 'synthesis' : 'bot')} ${meta.isSubItem ? 'sub-message' : ''}`;
        
        // MARKDOWN PARSING
        let htmlContent = isMe ? escapeHtml(text).replace(/\n/g, '<br>') : marked.parse(text);
        
        const ragPanel = buildRagPanel(sources);
        const actions = !isMe ? `<div class="message-actions"><button class="action-btn" onclick="copyToClipboard(this, \`${text.replace(/`/g, '\\`')}\`)"><i class="bi bi-clipboard"></i> Copier</button><button class="action-btn" onclick="reAsk(\`${text.replace(/`/g, '\\`')}\`)"><i class="bi bi-arrow-repeat"></i> Relancer</button></div>` : '';
        div.innerHTML = `${!isMe ? `<div class="message-avatar-large">${meta.avatar || 'ðŸ¤–'}</div>` : ''}<div class="message-bubble-container">${!isMe ? `<div class="message-sender">${meta.name}</div>` : ''}<div class="message-bubble">${htmlContent}${ragPanel}${actions}</div></div>`;
        const spacer = wrap.querySelector('.chat-bottom-spacer');
        if(spacer) wrap.insertBefore(div, spacer); else wrap.appendChild(div);
        scrollChatToBottom();
    }

    // --- UX ---
    function copyToClipboard(btn, val) { const el = document.createElement('textarea'); el.value = val; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); const old = btn.innerHTML; btn.innerHTML = '<i class="bi bi-check-lg"></i> CopiÃ©'; setTimeout(() => btn.innerHTML = old, 2000); }
    function reAsk(val) { const el = document.getElementById('chatInput'); el.innerText = val; el.focus(); const r = document.createRange(), s = window.getSelection(); r.selectNodeContents(el); r.collapse(false); s.removeAllRanges(); s.addRange(r); }
    function clearChat() { if(confirm('Effacer l\'historique visuel ?')) { document.getElementById('chatWrap').innerHTML = '<div class="chat-bottom-spacer"></div>'; } }
    function openPromptLibrary() { document.getElementById('promptGrid').innerHTML = PRESET_PROMPTS.map(p => `<div class="col-md-6"><div class="prompt-card" onclick="usePrompt(\`${p.text}\`)"><span class="icon">${p.icon}</span><h6>${p.title}</h6><p>${p.desc}</p></div></div>`).join(''); new bootstrap.Modal(document.getElementById('promptModal')).show(); }
    function usePrompt(text) { const el = document.getElementById('chatInput'); el.innerText = text; bootstrap.Modal.getInstance(document.getElementById('promptModal')).hide(); el.focus(); const r = document.createRange(), s = window.getSelection(); r.selectNodeContents(el); r.collapse(false); s.removeAllRanges(); s.addRange(r); }

    // --- MENTIONS ---
    function saveCurrentRange() { const sel = window.getSelection(); if (sel.rangeCount > 0) { const r = sel.getRangeAt(0); if (chatInput.contains(r.commonAncestorContainer)) lastSavedRange = r; } }
    chatInput.addEventListener('keyup', saveCurrentRange); chatInput.addEventListener('mouseup', saveCurrentRange); chatInput.addEventListener('focus', saveCurrentRange);
    chatInput.addEventListener('input', () => { const sel = window.getSelection(); if (!sel.rangeCount) return; const r = sel.getRangeAt(0); if (r.startContainer.nodeType !== Node.TEXT_NODE) { hideMentionMenu(); return; } const txt = r.startContainer.textContent.substring(0, r.startOffset), lastAt = txt.lastIndexOf('@'); if (lastAt !== -1) { const q = txt.substring(lastAt + 1).toLowerCase(), filtered = activePersonas.filter(p => p.ministry.toLowerCase().includes(q)); if (filtered.length > 0) { renderMentionMenu(filtered); showMentionMenu(); } else hideMentionMenu(); } else hideMentionMenu(); });
    chatInput.addEventListener('keydown', (e) => { if (mentionMenu.classList.contains('show')) { const items = mentionMenu.querySelectorAll('.mention-menu-item'); if (e.key === 'ArrowDown') { e.preventDefault(); selectedMenuIndex = (selectedMenuIndex + 1) % items.length; updateMenuSelection(items); } else if (e.key === 'ArrowUp') { e.preventDefault(); selectedMenuIndex = (selectedMenuIndex - 1 + items.length) % items.length; updateMenuSelection(items); } else if (e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); if (items[selectedMenuIndex]) items[selectedMenuIndex].click(); } else if (e.key === 'Escape') { hideMentionMenu(); } } else if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    function renderMentionMenu(personas) { mentionMenu.innerHTML = personas.map((p, i) => `<div class="mention-menu-item ${i === selectedMenuIndex ? 'selected' : ''}" onmousedown="event.preventDefault()" onclick="insertMention('${p.avatarEmoji}', '${p.ministry}')"><span>${p.avatarEmoji}</span><span class="fw-bold text-white small">${p.ministry}</span></div>`).join(''); }
    function updateMenuSelection(items) { items.forEach((it, i) => { if (i === selectedMenuIndex) it.classList.add('selected'); else it.classList.remove('selected'); }); }
    function showMentionMenu() { mentionMenu.classList.add('show'); }
    function hideMentionMenu() { mentionMenu.classList.remove('show'); selectedMenuIndex = 0; }
    function insertMentionDirectly(emoji, name) { chatInput.focus(); const sel = window.getSelection(); if (lastSavedRange) { sel.removeAllRanges(); sel.addRange(lastSavedRange); } const r = sel.getRangeAt(0), tag = createMentionTag(name); r.insertNode(tag); const s = document.createTextNode('\u00A0'); tag.after(s); const nr = document.createRange(); nr.setStartAfter(s); nr.collapse(true); sel.removeAllRanges(); sel.addRange(nr); lastSavedRange = nr; }
    function insertMention(emoji, name) { const sel = window.getSelection(); if (lastSavedRange) { sel.removeAllRanges(); sel.addRange(lastSavedRange); } if (!sel.rangeCount) return; const r = sel.getRangeAt(0), node = r.startContainer; if (node.nodeType === Node.TEXT_NODE) { const txt = node.textContent.substring(0, r.startOffset), lastAt = txt.lastIndexOf('@'); if (lastAt !== -1) { const dr = document.createRange(); dr.setStart(node, lastAt); dr.setEnd(node, r.startOffset); dr.deleteContents(); const tag = createMentionTag(name); dr.insertNode(tag); const s = document.createTextNode('\u00A0'); tag.after(s); const fr = document.createRange(); fr.setStartAfter(s); fr.collapse(true); sel.removeAllRanges(); sel.addRange(fr); lastSavedRange = fr; } } hideMentionMenu(); }
    function createMentionTag(name) { const tag = document.createElement('span'); tag.className = 'mention-tag'; tag.contentEditable = 'false'; tag.innerText = `@${name}`; return tag; }
    function toggleInspector() { document.getElementById('appInspector').classList.toggle('collapsed'); }
    function showNewRoomModal() { new bootstrap.Modal(document.getElementById('roomModal')).show(); }
    async function createRoom() { const name = document.getElementById('roomNameInput').value || "Conseil Ordinaire", ids = [...document.querySelectorAll('#personaSelector input:checked')].map(c => c.value); const res = await fetch('/api/rooms', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, selectedPersonaIds:ids}) }); const data = await res.json(); if(data.ok) { bootstrap.Modal.getInstance(document.getElementById('roomModal')).hide(); await refreshRoomList(); loadRoom(data.room.id); } }
    function uploadRag() { alert("Document prÃªt pour l'indexation n8n."); }

    init();
  </script>
</body>
</html>