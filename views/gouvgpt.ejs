<!-- 
  GouvBrain Frontend - UI/UX Refonte "Ultra Modern"
  Vue Salon avec s√©lection de Personas et Partage RAG
-->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GouvBrain ‚Ä¢ Conseil des Ministres IA</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    :root { 
        /* Palette "Deep Space" */
        --bg-body: #09090b;       /* Fond principal tr√®s sombre */
        --bg-sidebar: #0f1016;    /* Sidebar l√©g√®rement plus claire */
        --bg-surface: #18181b;    /* Cards, Modals */
        --bg-input: #27272a;      /* Input fields */
        
        --accent-primary: #3b82f6; /* Bleu vibrant */
        --accent-glow: rgba(59, 130, 246, 0.15);
        
        --text-primary: #f4f4f5;
        --text-secondary: #a1a1aa;
        --text-tertiary: #71717a;
        
        --border-subtle: #27272a;
        
        --font-main: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
    }
    
    body { 
        background-color: var(--bg-body); 
        color: var(--text-primary); 
        font-family: var(--font-main);
        height: 100vh; 
        overflow: hidden; 
        display: flex;
        flex-direction: column;
        line-height: 1.6;
    }

    /* --- Utilities --- */
    .glass-panel {
        background: rgba(24, 24, 27, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.05);
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

    /* --- Modale --- */
    .modal-content { 
        background-color: var(--bg-surface); 
        border: 1px solid var(--border-subtle); 
        color: var(--text-primary);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .modal-header { border-bottom: 1px solid var(--border-subtle); padding: 1.5rem 2rem; }
    .modal-body { padding: 2rem; }
    .modal-footer { border-top: 1px solid var(--border-subtle); padding: 1.5rem 2rem; }
    
    .form-control, .form-control:focus {
        background-color: var(--bg-body);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        border-radius: 12px;
        padding: 0.8rem 1rem;
    }
    .form-control:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* --- Header --- */
    header {
        background-color: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-subtle);
        height: 70px;
        flex-shrink: 0;
    }

    /* --- Layout --- */
    .app-container { 
        flex: 1; 
        display: flex; 
        overflow: hidden; 
        position: relative;
    }

    /* --- Sidebar --- */
    .sidebar { 
        width: 320px; 
        background-color: var(--bg-sidebar); 
        border-right: 1px solid var(--border-subtle); 
        display: flex;
        flex-direction: column;
        z-index: 10;
    }

    .persona-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 4px;
        transition: all 0.2s;
        border: 1px solid transparent;
        cursor: default;
    }
    .persona-list-item:hover { background: rgba(255,255,255,0.03); }
    .persona-list-item.active { 
        background: rgba(59, 130, 246, 0.1); 
        border-color: rgba(59, 130, 246, 0.2);
    }
    .persona-avatar {
        width: 40px; height: 40px;
        border-radius: 10px;
        background: var(--bg-surface);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem;
        border: 1px solid var(--border-subtle);
        flex-shrink: 0;
    }

    /* --- Chat Area --- */
    .chat-area { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        background: radial-gradient(circle at 50% -20%, #1e1b4b 0%, var(--bg-body) 60%);
        position: relative;
        overflow-y: auto;
        scroll-behavior: smooth;
    }
    
    .chat-wrap {
        padding: 2rem 15%; /* Centered reading experience */
        display: flex;
        flex-direction: column;
        gap: 2rem;
        min-height: 0; /* Important for flex child scrolling */
    }
    @media (max-width: 1400px) { .chat-wrap { padding: 2rem 5%; } }

    /* --- Messages --- */
    .message-group {
        display: flex;
        gap: 1.5rem;
        animation: slideUp 0.3s ease-out;
    }
    .message-group.me { flex-direction: row-reverse; }

    .message-avatar {
        width: 36px; height: 36px;
        border-radius: 8px;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem;
        margin-top: 4px;
        flex-shrink: 0;
    }

    .message-content {
        max-width: 75%;
        min-width: 200px;
    }
    .message-bubble {
        padding: 1rem 1.25rem;
        border-radius: 16px;
        font-size: 1rem;
        line-height: 1.6;
        position: relative;
    }

    /* Bot Style */
    .message-group.bot .message-bubble {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-top-left-radius: 4px;
        color: var(--text-secondary);
    }
    .message-sender {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-tertiary);
        display: flex; align-items: center; gap: 8px;
    }

    /* User Style */
    .message-group.me .message-bubble {
        background: var(--accent-primary);
        color: white;
        border-top-right-radius: 4px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Input Area --- */
    .input-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 0 2rem 2rem 2rem;
        position: sticky;
        bottom: 0;
        background: transparent;
        z-index: 20;
    }

    .input-box {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 8px;
        display: flex;
        align-items: flex-end;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        transition: border-color 0.2s;
    }
    .input-box:focus-within {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 1px var(--accent-primary), 0 -10px 40px rgba(0,0,0,0.3);
    }

    .chat-textarea {
        background: transparent;
        border: none;
        color: var(--text-primary);
        width: 100%;
        padding: 12px 16px;
        resize: none;
        outline: none;
        min-height: 48px;
        max-height: 200px;
        font-family: inherit;
        font-size: 1rem;
    }
    .chat-textarea::placeholder { color: var(--text-tertiary); }

    .action-btn {
        width: 40px; height: 40px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
        margin-bottom: 4px;
        margin-right: 4px;
    }
    .action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
    .send-btn {
        background: var(--accent-primary);
        color: white;
    }
    .send-btn:hover { background: #2563eb; transform: scale(1.05); }

    /* --- Empty State --- */
    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding-top: 10vh;
        color: var(--text-tertiary); text-align: center;
    }
    .empty-icon {
        width: 80px; height: 80px;
        background: rgba(255,255,255,0.03);
        border-radius: 20px;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-subtle);
    }

    /* --- Checkbox Card --- */
    .persona-select-card {
        background: var(--bg-body);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .persona-select-card:hover { border-color: var(--text-secondary); transform: translateY(-2px); }
    .form-check-input:checked + .persona-select-card {
        border-color: var(--accent-primary);
        background: rgba(59, 130, 246, 0.05);
    }
    .form-check-input:checked + .persona-select-card::after {
        content: "\F26E"; /* Bootstrap check icon */
        font-family: "bootstrap-icons";
        position: absolute; top: 10px; right: 10px;
        color: var(--accent-primary); font-size: 1.2rem;
    }

    /* Formating markdown simulation */
    .md-content ul { padding-left: 1.2rem; margin-bottom: 0.5rem; }
    .md-content li { margin-bottom: 0.25rem; }
    .md-content strong { color: #fff; font-weight: 600; }
    .md-content h1, .md-content h2, .md-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 1rem; color: #fff; }
  
    

  :root { 
        --bg-body: #09090b; --bg-sidebar: #0f1016; --bg-surface: #18181b; --text-primary: #f4f4f5; 
        --accent-primary: #3b82f6; --font-main: 'Plus Jakarta Sans', sans-serif;
    }
    body { background-color: var(--bg-body); color: var(--text-primary); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* Loader Sp√©cifique */
    .thinking-dots::after {
        content: ' .'; animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }

    /* Layout Chat */
    .chat-area { flex: 1; overflow-y: auto; background: radial-gradient(circle at 50% -20%, #172554 0%, var(--bg-body) 60%); padding: 2rem 15%; display: flex; flex-direction: column; gap: 1.5rem; }
    .sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid #27272a; display: flex; flex-direction: column; }
    
    /* Input Area */
    .input-container { max-width: 800px; margin: 0 auto; width: 100%; padding-bottom: 2rem; position: sticky; bottom: 0; }
    .input-box { background: var(--bg-surface); border: 1px solid #27272a; border-radius: 16px; padding: 0.8rem; display: flex; gap: 0.5rem; align-items: flex-end; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
    textarea { background: transparent; border: none; color: white; width: 100%; resize: none; outline: none; font-family: inherit; }
    
    /* Messages */
    .msg { display: flex; gap: 1rem; animation: slideIn 0.3s ease; }
    .msg.me { flex-direction: row-reverse; }
    .msg-content { padding: 1rem 1.25rem; border-radius: 16px; line-height: 1.6; position: relative; max-width: 80%; }
    .msg.bot .msg-content { background: var(--bg-surface); border: 1px solid #27272a; color: #e2e8f0; border-top-left-radius: 4px; }
    .msg.me .msg-content { background: var(--accent-primary); color: white; border-top-right-radius: 4px; }
    .avatar { width: 36px; height: 36px; border-radius: 8px; background: #27272a; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body>

  <!-- MODALE : CR√âATION DE SALON -->
  <div class="modal fade" id="roomModal" data-bs-backdrop="static" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <div>
              <h4 class="modal-title fw-bold">Initialisation de la Session</h4>
              <p class="text-secondary small mb-0">Configurez le panel du Conseil des Ministres IA</p>
          </div>
        </div>
        <div class="modal-body">
          <div class="mb-4">
            <label class="form-label text-uppercase small fw-bold text-tertiary mb-2">Objet de la r√©union</label>
            <input type="text" class="form-control form-control-lg" id="roomNameInput" placeholder="ex: Analyse d'Impact - Projet Loi Finances 2026">
          </div>

          <label class="form-label text-uppercase small fw-bold text-tertiary mb-3">Minist√®res Convoqu√©s</label>
          <div class="row g-3" id="personaSelector">
            <!-- Rempli par JS -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary btn-lg w-100 fw-bold" onclick="createRoom()">
            Lancer la Session
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="d-flex justify-content-between align-items-center px-4">
      <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center gap-2">
            <div class="bg-primary bg-opacity-25 p-2 rounded-3 text-primary">
                <i class="bi bi-cpu-fill fs-5"></i>
            </div>
            <div>
                <div class="fw-bold text-white lh-1" id="roomTitleDisplay">GouvBrain</div>
                <div class="small text-secondary" style="font-size: 0.75rem;">Conseil IA</div>
            </div>
          </div>
          <div class="vr bg-secondary opacity-25 mx-2 h-50"></div>
          <div class="d-flex align-items-center gap-2 px-3 py-1 rounded-pill" style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle);">
             <i class="bi bi-file-earmark-text text-tertiary"></i>
             <span class="small fw-medium" id="docCountBadge">0 Document(s)</span>
          </div>
      </div>
      <div>
          <a href="/admin" class="btn btn-sm btn-outline-secondary border-0 text-secondary hover-white">
              <i class="bi bi-sliders me-2"></i>Configuration
          </a>
      </div>
  </header>

  <!-- APP CONTAINER -->
  <div class="app-container" id="appShell" style="opacity: 0.3; pointer-events: none;">
    
    <!-- SIDEBAR -->
    <div class="sidebar p-3">
        <h6 class="text-tertiary text-uppercase small fw-bold mb-3 px-2">Participants</h6>
        <div id="activePersonasCol" class="d-flex flex-column gap-1">
            <!-- Liste dynamique -->
        </div>
        
        <div class="mt-auto px-2 pt-3 border-top border-secondary border-opacity-10">
            <div class="small text-tertiary d-flex justify-content-between">
                <span>Statut Syst√®me</span>
                <span class="text-success">‚óè Op√©rationnel</span>
            </div>
        </div>
    </div>

    <!-- CHAT AREA -->
    <div class="chat-area">
        <div id="chatWrap" class="chat-wrap">
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="bi bi-stars"></i>
                </div>
                <h3 class="fw-semibold text-white mb-2">Session Ouverte</h3>
                <p class="text-secondary" style="max-width: 400px;">
                    Le conseil est r√©uni. Posez une question pour solliciter l'avis des minist√®res ou d√©posez un document PDF pour analyse contextuelle.
                </p>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div class="input-container">
            <!-- Upload Status -->
            <div id="uploadStatus" class="small text-secondary mb-2 ps-1" style="min-height: 20px;"></div>

            <div class="input-box">
                <!-- File Upload -->
                <input type="file" id="ragInput" class="d-none" accept=".pdf,.txt,.docx" onchange="uploadRag()">
                <button class="action-btn" onclick="document.getElementById('ragInput').click()" title="Joindre un document">
                    <i class="bi bi-paperclip fs-5"></i>
                </button>
                
                <!-- Textarea -->
                <textarea id="chatInput" class="chat-textarea" rows="1" placeholder="Posez votre question au conseil..." oninput="autoResize(this)"></textarea>
                
                <!-- Send Button -->
                <button class="action-btn send-btn" onclick="sendMessage()">
                    <i class="bi bi-arrow-up-short fs-4"></i>
                </button>
            </div>
            <div class="text-center mt-2">
                <span class="small text-tertiary" style="font-size: 0.75rem;">Les r√©ponses sont g√©n√©r√©es par IA et doivent √™tre v√©rifi√©es.</span>
            </div>
        </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentRoomId = null;
    let allPersonas = [];
    let activePersonas = [];
    let docCount = 0;

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
    }

    // --- 1. INITIALISATION ---
    async function init() {
        try {
            const res = await fetch('/api/admin/personas');
            const config = await res.json();
            allPersonas = config.personas;

            const selector = document.getElementById('personaSelector');
            selector.innerHTML = allPersonas.map(p => `
                <div class="col-md-6">
                    <input class="form-check-input d-none" type="checkbox" value="${p.id}" id="chk_${p.id}" checked>
                    <label class="persona-select-card d-flex align-items-center gap-3 w-100" for="chk_${p.id}">
                        <div class="fs-2 p-2 bg-body rounded-3 border border-secondary border-opacity-10">${p.avatarEmoji}</div>
                        <div>
                            <div class="fw-bold text-white">${p.ministry}</div>
                            <div class="small text-secondary">${p.name}</div>
                        </div>
                    </label>
                </div>
            `).join('');

            new bootstrap.Modal(document.getElementById('roomModal')).show();
        } catch (e) {
            console.error("Erreur init:", e);
        }
    }

    // --- 2. CR√âATION SALON ---
    async function createRoom() {
        const nameInput = document.getElementById('roomNameInput');
        const name = nameInput.value || "Session Ordinaire";
        const checked = [...document.querySelectorAll('#personaSelector input:checked')].map(cb => cb.value);
        
        const btn = document.querySelector('.modal-footer button');
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Initialisation...';

        try {
            const res = await fetch('/api/rooms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ name, selectedPersonaIds: checked })
            });
            const data = await res.json();
            
            if(data.ok) {
                currentRoomId = data.room.id;
                activePersonas = allPersonas.filter(p => data.room.activePersonas.includes(p.id));
                
                document.getElementById('roomTitleDisplay').innerHTML = `${data.room.name}`;
                document.querySelector('.modal.show').classList.remove('show');
                document.querySelector('.modal-backdrop').remove();
                document.getElementById('roomModal').style.display = 'none';
                
                const shell = document.getElementById('appShell');
                shell.style.opacity = '1';
                shell.style.pointerEvents = 'all';

                renderSidebar();
            }
        } catch (e) {
            alert("Erreur cr√©ation salon");
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    function renderSidebar() {
        const container = document.getElementById('activePersonasCol');
        container.innerHTML = activePersonas.map(p => `
            <div class="persona-list-item" id="sidebar_p_${p.id}">
                <div class="persona-avatar">${p.avatarEmoji}</div>
                <div class="overflow-hidden flex-grow-1">
                    <div class="fw-semibold text-white text-truncate" style="font-size:0.9rem">${p.ministry}</div>
                    <div class="text-secondary small text-truncate" style="font-size:0.75rem">${p.role}</div>
                </div>
                <div class="spinner-border spinner-border-sm text-primary d-none" id="loader_${p.id}"></div>
            </div>
        `).join('');
    }

    // --- 3. GESTION UPLOAD RAG ---
    async function uploadRag() {
        const fileInput = document.getElementById('ragInput');
        const file = fileInput.files[0];
        if(!file) return;

        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.innerHTML = `<span class="spinner-border spinner-border-sm text-primary me-2"></span> <span class="text-light">S√©curisation et indexation de ${file.name}...</span>`;

        const fd = new FormData();
        fd.append('file', file);
        
        try {
            const res = await fetch(`/api/rooms/${currentRoomId}/ingest`, { method: 'POST', body: fd });
            const data = await res.json();
            
            if(data.ok) {
                statusDiv.innerHTML = `<span class="text-success"><i class="bi bi-check-circle-fill me-2"></i> ${file.name} ajout√© au contexte.</span>`;
                setTimeout(() => { statusDiv.innerHTML = ''; }, 4000);
                
                docCount++;
                document.getElementById('docCountBadge').innerText = `${docCount} Doc(s)`;
                
                addSystemMessage(`üìÇ <strong>Nouveau document au dossier :</strong> ${file.name}`);
            } else {
                statusDiv.innerHTML = `<span class="text-danger">Erreur: ${data.error}</span>`;
            }
        } catch(e) {
            statusDiv.innerHTML = `<span class="text-danger">Erreur r√©seau</span>`;
        }
        fileInput.value = "";
    }

    // --- 4. CHAT ---
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;

        const emptyState = document.querySelector('.empty-state');
        if(emptyState) emptyState.remove();

        input.value = "";
        input.style.height = 'auto'; // Reset height
        
        addChatLine({ name: "Moi", text: text }, true);

        // Envoyer √† tous les minist√®res
        activePersonas.forEach(p => askPersona(p, text));
    }

    async function askPersona(persona, question) {
        const loader = document.getElementById(`loader_${persona.id}`);
        const sidebarItem = document.getElementById(`sidebar_p_${persona.id}`);
        
        if(loader) loader.classList.remove('d-none');
        if(sidebarItem) sidebarItem.classList.add('active');

        try {
            const res = await fetch('/api/chat/n8n', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    roomId: currentRoomId,
                    personaId: persona.id,
                    message: question
                })
            });
            const data = await res.json();
            
            addChatLine({
                name: `${persona.ministry}`,
                text: data.response,
                color: persona.color,
                avatar: persona.avatarEmoji
            }, false);

        } catch (e) {
            addChatLine({
                name: "Erreur Syst√®me",
                text: `Le minist√®re ${persona.ministry} est injoignable.`,
                color: "red",
                avatar: "‚ö†Ô∏è"
            }, false);
        } finally {
            if(loader) loader.classList.add('d-none');
            if(sidebarItem) sidebarItem.classList.remove('active');
        }
    }

    function addChatLine(msgData, isMe) {
        const chatArea = document.querySelector('.chat-area');
        const wrap = document.getElementById('chatWrap');
        const div = document.createElement('div');
        
        div.className = isMe ? "message-group me" : "message-group bot";
        
        if (isMe) {
            div.innerHTML = `
                <div class="message-content">
                    <div class="message-bubble">${formatText(msgData.text)}</div>
                </div>
            `;
        } else {
            div.innerHTML = `
                <div class="message-avatar">${msgData.avatar || 'üèõÔ∏è'}</div>
                <div class="message-content">
                    <div class="message-sender">${msgData.name}</div>
                    <div class="message-bubble md-content">${formatText(msgData.text)}</div>
                </div>
            `;
        }
        
        wrap.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function addSystemMessage(htmlContent) {
        const chatArea = document.querySelector('.chat-area');
        const wrap = document.getElementById('chatWrap');
        const div = document.createElement('div');
        
        const emptyState = document.querySelector('.empty-state');
        if(emptyState) emptyState.remove();

        div.className = "text-center my-4";
        div.innerHTML = `
            <span class="d-inline-block px-3 py-1 rounded-pill border border-secondary border-opacity-25 text-tertiary small bg-surface">
                ${htmlContent}
            </span>
        `;
        wrap.appendChild(div);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    function formatText(text) {
        if (!text) return "";
        return text
            .replace(/\n/g, '<br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/- (.*?)(<br>|$)/g, '<li>$1</li>');
    }

    // Event Enter sur textarea
    document.getElementById('chatInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    init();
  </script>
</body>
</html>