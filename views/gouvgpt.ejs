<%
/*
gouvbrain.ejs ‚Äî AI Cabinet Meeting Dashboard (Gov of Congo)
‚úÖ NO MOCKS / NO DEMO MODE
‚úÖ All buttons call real APIs
‚úÖ Status lights are live (polling health endpoints)

Expected (optional) server-side variables:
  - user: { name }
  - cabinetTitle: string
  - meetingName: string
  - personas: [{ id, name, role, ministry, focus, color, avatarEmoji }]

Backend endpoints (CURRENT SAFE MODE):
  ‚úÖ POST /api/gouvbrain/ingest        (multipart/form-data: pdf) -> { docId, title, pages, summary, keyTopics[] }
  ‚úÖ POST /api/ollama/chat             (json Ollama chat payload) -> { message: { content } } (or proxy-compatible)
  ‚úÖ GET  /api/health
  ‚úÖ GET  /api/ollama/health
  ‚úÖ GET  /api/ollama/tags

Notes:
  - Multi-persona analysis is performed CLIENT-SIDE (loops over personas calling /api/ollama/chat).
  - /api/gouvbrain/analyze and /api/gouvbrain/doc/:docId are NOT REQUIRED in this safe version.
*/
%>

<%
  const DEFAULT_PERSONAS = [
    { id:"pm", name:"Premier Ministre", role:"Chair", ministry:"Primature", focus:"Arbitrage, priorit√©s, ex√©cution", color:"#22c55e", avatarEmoji:"üü¢" },
    { id:"fin", name:"Ministre des Finances", role:"SME", ministry:"Finances", focus:"Budget, fiscalit√©, soutenabilit√©", color:"#f59e0b", avatarEmoji:"üü†" },
    { id:"plan", name:"Plan & D√©veloppement", role:"SME", ministry:"Plan", focus:"ROI, investissements, PPP", color:"#a855f7", avatarEmoji:"üü£" },
    { id:"int", name:"Int√©rieur", role:"SME", ministry:"Int√©rieur", focus:"S√©curit√© int√©rieure, gouvernance locale", color:"#3b82f6", avatarEmoji:"üîµ" },
    { id:"just", name:"Justice", role:"SME", ministry:"Justice", focus:"Conformit√©, risques juridiques", color:"#ef4444", avatarEmoji:"üî¥" },
    { id:"def", name:"D√©fense", role:"SME", ministry:"D√©fense", focus:"Souverainet√©, risques strat√©giques", color:"#64748b", avatarEmoji:"‚ö´" },
    { id:"health", name:"Sant√©", role:"SME", ministry:"Sant√©", focus:"Impact sanitaire, urgence, capacit√©s", color:"#14b8a6", avatarEmoji:"üü¶" },
    { id:"edu", name:"√âducation", role:"SME", ministry:"√âducation", focus:"Comp√©tences, formation, inclusion", color:"#06b6d4", avatarEmoji:"üßä" },
    { id:"energy", name:"Hydrocarbures & √ânergie", role:"SME", ministry:"√ânergie", focus:"√ânergie, cha√Æne de valeur, revenus", color:"#fb7185", avatarEmoji:"üå∏" },
    { id:"digital", name:"√âconomie Num√©rique", role:"SME", ministry:"Num√©rique", focus:"Data, IA, cyber, interop√©rabilit√©", color:"#10b981", avatarEmoji:"üü©" },
    { id:"env", name:"Environnement", role:"SME", ministry:"Environnement", focus:"ESG, conformit√©, climat", color:"#84cc16", avatarEmoji:"üü©" },
  ];

  const cabinetTitle = typeof locals.cabinetTitle !== "undefined" ? locals.cabinetTitle : "GouvBrain ‚Äî Conseil des Ministres (R√©publique du Congo)";
  const meetingName  = typeof locals.meetingName  !== "undefined" ? locals.meetingName  : "Session IA ‚Ä¢ Analyse & D√©cision";
  const personas     = (locals.personas && locals.personas.length) ? locals.personas : DEFAULT_PERSONAS;
  const userName     = (locals.user && locals.user.name) ? locals.user.name : "Secr√©tariat G√©n√©ral";
%>

<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title><%= cabinetTitle %></title>

  <!-- Bootstrap + Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1220;
      --card:#0E1A2B;
      --card2:#0B1525;
      --txt:#EAF2FF;
      --muted:#9FB2D0;
      --line:rgba(255,255,255,.08);
      --glow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 22px;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --off:rgba(255,255,255,.18);
    }

    html,body{
      height:100%;
      background:
        radial-gradient(1200px 600px at 15% 0%, rgba(34,197,94,.18), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(59,130,246,.18), transparent 60%),
        radial-gradient(900px 600px at 50% 90%, rgba(168,85,247,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--txt);
      overscroll-behavior: none;
    }

    .app-shell{
      height:100%;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(7,10,18,.68);
      border-bottom:1px solid var(--line);
    }

    .brand-pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding:.5rem .9rem;
      display:flex; align-items:center; gap:.6rem;
      max-width: min(820px, 100%);
    }

    .brand-dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, #22c55e, #3b82f6);
      box-shadow: 0 0 0 3px rgba(34,197,94,.12), 0 0 22px rgba(59,130,246,.35);
      flex: 0 0 auto;
    }

    .status-pills{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .sp{
      border:1px solid var(--line);
      border-radius:999px;
      padding:.28rem .55rem;
      background: rgba(255,255,255,.03);
      font-size:.78rem;
      color: var(--muted);
      display:flex; align-items:center; gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .led{
      width:10px; height:10px; border-radius:999px;
      background: var(--off);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
    }
    .led.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,.14), 0 0 18px rgba(34,197,94,.35); }
    .led.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.16), 0 0 18px rgba(245,158,11,.35); }
    .led.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(239,68,68,.14), 0 0 18px rgba(239,68,68,.35); }

    .main{ flex:1; overflow:hidden; padding: 14px 14px 0 14px; }

    .grid{
      height:100%;
      display:grid;
      grid-template-columns: 360px 1.25fr 420px;
      gap: 14px;
      overflow:hidden;
      min-height: 0;
    }

    @media (max-width: 1400px){
      .grid{ grid-template-columns: 320px 1fr 380px; }
    }

    @media (max-width: 1200px){
      .main{ padding: 12px 12px 0 12px; }
      .grid{
        grid-template-columns: 1fr;
        grid-auto-rows: minmax(320px, 1fr);
      }
      .panel{ min-height: 360px; }
      .brand-pill{ border-radius: 18px; }
    }

    @media (max-width: 576px){
      .main{ padding: 10px 10px 0 10px; }
      .panel-header{ padding: 10px 10px; }
      .persona-list, .chat-wrap, .doc-body{ padding: 10px; }
      .msg .bubble{ max-width: 100%; }
      .brand-pill{ padding: .5rem .7rem; }
    }

    .panel{
      background: rgba(14,26,43,.72);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--glow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .panel-header{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
      flex-wrap: wrap;
    }

    .panel-title{
      display:flex; gap:.65rem; align-items:center;
      font-weight:700;
      letter-spacing:.2px;
      min-width: 0;
    }

    .chip{
      font-size:.78rem;
      color: var(--muted);
      border:1px solid var(--line);
      border-radius:999px;
      padding:.25rem .55rem;
      background: rgba(255,255,255,.03);
      white-space: nowrap;
    }

    .persona-list{ padding: 12px; overflow:auto; flex:1; }

    .persona-card{
      border:1px solid var(--line);
      border-radius: 18px;
      padding: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
      display:flex;
      gap:12px;
      align-items:stretch;
      cursor:pointer;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      position:relative;
      overflow:hidden;
    }
    .persona-card:hover{
      transform: translateY(-2px) scale(1.01);
      border-color: rgba(255,255,255,.16);
      box-shadow: 0 18px 42px rgba(0,0,0,.45);
    }
    .persona-card.active{
      outline: 2px solid rgba(59,130,246,.45);
      box-shadow: 0 0 0 6px rgba(59,130,246,.10), 0 22px 60px rgba(0,0,0,.55);
    }
    .persona-aura{
      position:absolute; inset:-60px -60px auto auto;
      width:180px; height:180px; border-radius: 999px;
      filter: blur(18px);
      opacity:.35;
      pointer-events:none;
      transform: translate(10px, -10px);
    }

    .avatar{
      width:54px; height:54px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      font-size: 1.3rem;
      flex: 0 0 auto;
      position:relative;
    }
    .avatar::after{
      content:"";
      position:absolute; inset:-2px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(59,130,246,.18), rgba(168,85,247,.16));
      z-index:-1;
      filter: blur(10px);
      opacity:.55;
    }

    .persona-meta{ flex:1; min-width:0; }
    .persona-meta h6{ margin:0; font-weight:800; }
    .persona-meta p{ margin:.25rem 0 0; color:var(--muted); font-size:.88rem; line-height:1.2; }
    .persona-mini{ display:flex; flex-wrap:wrap; gap:6px; margin-top:.5rem; }

    .chat-wrap{
      padding: 12px;
      overflow:auto;
      flex:1;
      background:
        radial-gradient(650px 280px at 30% 0%, rgba(34,197,94,.08), transparent 60%),
        radial-gradient(650px 280px at 70% 0%, rgba(59,130,246,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
    }

    .msg{ display:flex; gap:10px; margin-bottom: 10px; align-items:flex-start; }
    .msg .bubble{
      max-width: 78%;
      padding: 10px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      white-space:pre-wrap;
      word-break: break-word;
    }
    .msg.me{ justify-content:flex-end; }
    .msg.me .bubble{ background: rgba(59,130,246,.10); border-color: rgba(59,130,246,.22); }
    .msg .who{ font-size:.78rem; color: var(--muted); margin-bottom: 3px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }

    .composer{
      padding: 12px;
      border-top:1px solid var(--line);
      background: rgba(7,10,18,.45);
    }

    .composer .form-control{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--txt);
      border-radius: 16px;
    }
    .composer .form-control:focus{
      box-shadow: 0 0 0 .25rem rgba(59,130,246,.15);
      border-color: rgba(59,130,246,.3);
    }

    .doc-body{ padding: 12px; overflow:auto; flex:1; }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 576px){
      .kpi{ grid-template-columns: 1fr; }
    }

    .kpi .box{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background: rgba(255,255,255,.02);
      min-width: 0;
    }
    .box .label{ color: var(--muted); font-size:.78rem; }
    .box .value{ font-weight:800; font-size:1.05rem; margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .analysis-card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }
    .analysis-card h6{ margin:0 0 6px 0; font-weight:800; }
    .analysis-card ul{ margin: 0; padding-left: 18px; color: var(--muted); }
    .analysis-card .stance{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: .25rem .55rem;
      border:1px solid var(--line);
      border-radius:999px;
      font-size:.78rem;
      color: var(--muted);
      background: rgba(255,255,255,.02);
      margin-bottom: 8px;
    }

    .alert-card{
      border: 1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.06);
      border-radius: 18px;
      padding: 12px;
      margin-top: 10px;
    }

    .footerbar{
      position:sticky; bottom:0; z-index:50;
      border-top:1px solid var(--line);
      background: rgba(7,10,18,.68);
      backdrop-filter: blur(14px);
      padding: 10px 14px;
    }

    .dropzone{
      border: 1.5px dashed rgba(255,255,255,.18);
      border-radius: 18px;
      background: rgba(255,255,255,.03);
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      transition: border-color .18s ease, background .18s ease, transform .18s ease;
      flex-wrap: wrap;
    }
    .dropzone.dragover{
      border-color: rgba(34,197,94,.45);
      background: rgba(34,197,94,.08);
      transform: translateY(-1px);
    }

    .tiny{ font-size:.82rem; color: var(--muted); }

    .btn-soft{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      color: var(--txt);
    }
    .btn-soft:hover{
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.06);
      color: var(--txt);
    }

    .progress{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
    }
    .progress-bar{ width:0%; transition: width .18s ease; }

    .blink{ animation: blink 1.1s infinite ease-in-out; }
    @keyframes blink{ 0%,100%{ opacity:.35; } 50%{ opacity:1; } }
  </style>
</head>

<body>
  <div class="app-shell">

    <!-- TOP BAR -->
    <div class="topbar">
      <div class="container-fluid py-2">
        <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
          <div class="d-flex align-items-center gap-2 flex-wrap" style="min-width:0;">
            <div class="brand-pill" style="min-width:0;">
              <span class="brand-dot"></span>
              <div style="min-width:0;">
                <div class="fw-bold text-truncate" style="line-height:1.05; max-width: 70vw;"><%= cabinetTitle %></div>
                <div class="tiny"><i class="bi bi-stars"></i> <%= meetingName %> ‚Ä¢ <span class="blink">LIVE</span></div>
              </div>
            </div>

            <div class="status-pills ms-1">
              <div class="sp" title="API principale">
                <span class="led" id="ledApi"></span> API
              </div>
              <div class="sp" title="Ollama">
                <span class="led" id="ledOllama"></span> Ollama
              </div>
              <div class="sp" title="Aidesk">
                <span class="led" id="ledAidesk"></span> Aidesk
              </div>
              <div class="sp" title="Firewall stats">
                <span class="led" id="ledFirewall"></span> Firewall
              </div>
            </div>

            <span class="chip d-none d-md-inline"><i class="bi bi-shield-lock"></i> Mode confidentiel</span>
            <span class="chip d-none d-lg-inline"><i class="bi bi-diagram-3"></i> Personas synchronis√©es</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="chip"><i class="bi bi-person-circle"></i> <%= userName %></span>
            <button class="btn btn-soft btn-sm" id="btnClear"><i class="bi bi-trash3"></i> Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="main">
      <div class="grid">

        <!-- LEFT: PERSONAS -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-people"></i>
              Cabinet IA
              <span class="chip" id="docChip">Aucun document</span>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-soft btn-sm" id="btnAnalyzeAll" title="Lancer l‚Äôanalyse multi-personas">
                <i class="bi bi-lightning-charge"></i>
              </button>
            </div>
          </div>

          <div class="persona-list" id="personaList">
            <% personas.forEach(p => { %>
              <div class="persona-card mb-2" data-persona-id="<%= p.id %>" tabindex="0">
                <div class="persona-aura" style="background:<%= p.color %>;"></div>
                <div class="avatar" style="box-shadow: 0 0 0 4px rgba(255,255,255,.03), 0 0 32px <%= p.color %>33;">
                  <span><%= p.avatarEmoji || "ü§ñ" %></span>
                </div>
                <div class="persona-meta">
                  <h6><%= p.name %></h6>
                  <p><span class="fw-semibold"><%= p.ministry %></span> ‚Ä¢ <%= p.focus %></p>
                  <div class="persona-mini">
                    <span class="chip"><i class="bi bi-person-badge"></i> <%= p.role %></span>
                    <span class="chip"><i class="bi bi-eye"></i> Perspective</span>
                    <span class="chip"><i class="bi bi-zoom-in"></i> Zoom</span>
                  </div>
                </div>
              </div>
            <% }) %>
          </div>
        </div>

        <!-- CENTER: CHATBOARD -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-chat-dots"></i>
              Chatboard Cabinet
              <span class="chip" id="modeChip">Mode: Cabinet</span>
            </div>

            <div class="d-flex gap-2 align-items-center flex-wrap">
              <select class="form-select form-select-sm" id="personaMode" style="width: 220px; background: rgba(255,255,255,.03); color: var(--txt); border-color: rgba(255,255,255,.10); border-radius: 14px;">
                <option value="cabinet">Cabinet (tous)</option>
                <option value="single">Persona s√©lectionn√©e</option>
              </select>
              <button class="btn btn-soft btn-sm" id="btnSummarize"><i class="bi bi-file-text"></i> R√©sumer</button>
            </div>
          </div>

          <div class="chat-wrap" id="chatWrap">
            <div class="msg">
              <div class="avatar" style="width:38px;height:38px;border-radius:14px;">
                <span>üß†</span>
              </div>
              <div>
                <div class="who">GouvBrain <span class="chip">syst√®me</span></div>
                <div class="bubble">
Bienvenue. D√©posez un PDF dans la zone d‚Äôingestion en bas.
Ensuite, chaque membre du cabinet IA produira une analyse (risques, opportunit√©s, d√©cisions, actions).
                </div>
              </div>
            </div>
          </div>

          <div class="composer">
            <div class="d-flex gap-2">
              <input id="chatInput" class="form-control" placeholder="Posez une question au Cabinet IA‚Ä¶ (ex: 'Quels risques budg√©taires ?' / 'D√©cision recommand√©e ?')" />
              <button class="btn btn-soft" id="btnSend"><i class="bi bi-send"></i></button>
            </div>
            <div class="d-flex align-items-center justify-content-between mt-2 flex-wrap gap-2">
              <div class="tiny">
                <i class="bi bi-info-circle"></i>
                Astuce: utilisez <span class="chip">Mode Persona</span> pour interroger un seul expert.
              </div>
              <div class="tiny" id="statusLine">‚óè Pr√™t</div>
            </div>
          </div>
        </div>

        <!-- RIGHT: DOCUMENT + ANALYSIS -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="bi bi-file-earmark-pdf"></i>
              Dossier & Analyses
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-soft btn-sm" id="btnExport" title="Exporter (via API si disponible)">
                <i class="bi bi-download"></i>
              </button>
            </div>
          </div>

          <div class="doc-body" id="docBody">
            <div class="kpi">
              <div class="box">
                <div class="label">Document</div>
                <div class="value" id="docTitle">‚Äî</div>
              </div>
              <div class="box">
                <div class="label">Statut</div>
                <div class="value" id="docStatus">En attente</div>
              </div>
              <div class="box">
                <div class="label">Pages</div>
                <div class="value" id="docPages">‚Äî</div>
              </div>
              <div class="box">
                <div class="label">DocID</div>
                <div class="value" id="docId">‚Äî</div>
              </div>
            </div>

            <div class="analysis-card mt-3">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6><i class="bi bi-journal-text"></i> R√©sum√© ex√©cutif</h6>
                <span class="chip" id="topicsChip">0 th√®mes</span>
              </div>
              <div class="tiny mt-2" id="docSummary">D√©posez un PDF pour g√©n√©rer un r√©sum√© et activer les analyses multi-personas.</div>
            </div>

            <!-- Contradictions + Arbitrages (dynamic) -->
            <div id="contradictionArea" class="mt-2"></div>

            <div id="analysisArea" class="mt-2"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- FOOTER INGESTION ZONE -->
    <div class="footerbar">
      <div class="dropzone" id="dropzone">
        <div class="d-flex align-items-center gap-3 flex-wrap" style="flex: 1 1 520px;">
          <div class="d-flex align-items-center gap-2">
            <div class="avatar" style="width:44px;height:44px;border-radius:16px;">
              <span>üì•</span>
            </div>
            <div style="min-width:0;">
              <div class="fw-bold">Ingestion PDF</div>
              <div class="tiny">Glissez-d√©posez un PDF ici, ou cliquez pour s√©lectionner. Le Cabinet IA se d√©clenche ensuite.</div>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2 flex-wrap">
            <input type="file" id="pdfInput" accept="application/pdf" hidden />
            <button class="btn btn-soft" id="btnPick"><i class="bi bi-upload"></i> Choisir PDF</button>
            <button class="btn btn-soft" id="btnIngest" disabled><i class="bi bi-cpu"></i> Ingest</button>
          </div>
        </div>

        <div class="d-flex align-items-center gap-3" style="min-width: min(420px, 100%); flex: 1 1 420px;">
          <div class="w-100">
            <div class="d-flex justify-content-between tiny mb-1">
              <span id="fileName">Aucun fichier</span>
              <span id="fileSize">‚Äî</span>
            </div>
            <div class="progress">
              <div class="progress-bar bg-success" id="progBar"></div>
            </div>
          </div>
          <span class="chip" id="ingestMode">API</span>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ----------------------------
    // State (NO DEMO)
    // ----------------------------
    const state = {
      docId: null,
      docTitle: null,
      docPages: null,
      topics: [],
      selectedPersonaId: "<%= personas[0]?.id || 'pm' %>",
      file: null,
      lastCabinetReplies: [] // [{personaId, ministry, text, decision}]
    };

    const personas = <%- JSON.stringify(personas) %>;

    // ‚úÖ SAFE: always hit same origin (correct host:port)
    const API_BASE = window.location.origin;

    // ----------------------------
    // Ministry Playbook (dynamic routing + non-generic answers)
    // ----------------------------
    const MINISTRY_PLAYBOOK = {
      "Primature": {
        angle: "arbitrage inter-minist√©riel, priorisation, gouvernance d‚Äôex√©cution",
        mustMention: ["arbitrage", "responsables", "d√©lais", "coordination", "instructions", "suivi"],
        kpi: ["% mesures ex√©cut√©es", "d√©lai de mise en ≈ìuvre", "taux de conformit√© inter-minist√®res"]
      },
      "Finances": {
        angle: "co√ªts, financement, soutenabilit√© budg√©taire, contr√¥le et tra√ßabilit√©",
        mustMention: ["budget", "co√ªt", "financement", "contr√¥le", "ligne budg√©taire", "audit"],
        kpi: ["co√ªt estim√©", "√©cart budg√©taire", "taux de couverture financement"]
      },
      "Plan": {
        angle: "impact socio-√©conomique, ROI, investissements, PPP, phasage",
        mustMention: ["ROI", "investissements", "phasage", "PPP", "priorit√©s", "indicateurs"],
        kpi: ["ROI projet√©", "emplois/impacts", "taux d‚Äôach√®vement jalons"]
      },
      "Int√©rieur": {
        angle: "ex√©cution terrain, s√©curit√© int√©rieure, ordre public, gouvernance locale",
        mustMention: ["terrain", "proc√©dures", "forces", "commandement", "pr√©fectures", "coordination locale"],
        kpi: ["taux d‚Äôincidents", "temps de r√©ponse", "couverture territoriale"]
      },
      "Justice": {
        angle: "base l√©gale, conformit√©, risques juridiques, responsabilit√© et recours",
        mustMention: ["base l√©gale", "conformit√©", "responsabilit√©", "sanctions", "recours", "d√©crets/arr√™t√©s"],
        kpi: ["nb textes requis", "risque contentieux", "taux conformit√©"]
      },
      "D√©fense": {
        angle: "souverainet√©, risques strat√©giques, continuit√©, coordination s√©curit√©",
        mustMention: ["souverainet√©", "continuit√©", "menaces", "r√©silience", "coordination", "plan de crise"],
        kpi: ["niveau menace", "temps de mobilisation", "couverture risques critiques"]
      },
      "Sant√©": {
        angle: "surveillance sanitaire, capacit√©s hospitali√®res, protocoles, approvisionnements",
        mustMention: ["surveillance", "h√¥pitaux", "protocoles", "stocks", "tests", "vaccination si pertinent"],
        kpi: ["taux occupation lits", "d√©lai d√©pistage", "niveau stocks critiques"]
      },
      "√âducation": {
        angle: "continuit√© p√©dagogique, pr√©vention, formation, inclusion",
        mustMention: ["continuit√©", "protocoles", "formation", "inclusion", "√©coles", "sensibilisation"],
        kpi: ["taux pr√©sence", "taux couverture formation", "incidents sanitaires √©coles"]
      },
      "√ânergie": {
        angle: "continuit√© √©nerg√©tique, cha√Æne de valeur, revenus, risques d‚Äôapprovisionnement",
        mustMention: ["continuit√©", "approvisionnement", "revenus", "logistique", "s√©curit√© sites", "prix"],
        kpi: ["taux disponibilit√©", "pertes/logistique", "recettes secteur"]
      },
      "Num√©rique": {
        angle: "donn√©es, IA, cyber, interop√©rabilit√©, tableaux de bord, tra√ßabilit√©",
        mustMention: ["donn√©es", "KPI", "interop√©rabilit√©", "cyber", "tableau de bord", "qualit√©"],
        kpi: ["latence data", "taux disponibilit√©", "taux incidents cyber"]
      },
      "Environnement": {
        angle: "ESG, conformit√©, risques climatiques/impacts, contr√¥le",
        mustMention: ["conformit√©", "impacts", "ESG", "mesures", "contr√¥le", "pr√©vention"],
        kpi: ["incidents environnementaux", "taux conformit√©", "r√©duction impacts"]
      }
    };

    // ----------------------------
    // DOM
    // ----------------------------
    const personaList   = document.getElementById("personaList");
    const modeChip      = document.getElementById("modeChip");
    const docChip       = document.getElementById("docChip");
    const personaMode   = document.getElementById("personaMode");

    const chatWrap      = document.getElementById("chatWrap");
    const chatInput     = document.getElementById("chatInput");
    const btnSend       = document.getElementById("btnSend");

    const pdfInput      = document.getElementById("pdfInput");
    const btnPick       = document.getElementById("btnPick");
    const btnIngest     = document.getElementById("btnIngest");
    const dropzone      = document.getElementById("dropzone");
    const fileName      = document.getElementById("fileName");
    const fileSize      = document.getElementById("fileSize");
    const progBar       = document.getElementById("progBar");

    const docTitleEl    = document.getElementById("docTitle");
    const docStatusEl   = document.getElementById("docStatus");
    const docPagesEl    = document.getElementById("docPages");
    const docIdEl       = document.getElementById("docId");
    const docSummaryEl  = document.getElementById("docSummary");
    const topicsChip    = document.getElementById("topicsChip");
    const analysisArea  = document.getElementById("analysisArea");
    const contradictionArea = document.getElementById("contradictionArea");
    const statusLine    = document.getElementById("statusLine");

    const btnAnalyzeAll = document.getElementById("btnAnalyzeAll");
    const btnSummarize  = document.getElementById("btnSummarize");
    const btnClear      = document.getElementById("btnClear");
    const btnExport     = document.getElementById("btnExport");

    // Status LEDs
    const ledApi      = document.getElementById("ledApi");
    const ledOllama   = document.getElementById("ledOllama");
    const ledAidesk   = document.getElementById("ledAidesk");
    const ledFirewall = document.getElementById("ledFirewall");

    // ----------------------------
    // Helpers
    // ----------------------------
    function fmtBytes(bytes){
      if(!bytes && bytes !== 0) return "‚Äî";
      const units = ["B","KB","MB","GB"];
      let i=0, n=bytes;
      while(n>=1024 && i<units.length-1){ n/=1024; i++; }
      return `${n.toFixed(i?1:0)} ${units[i]}`;
    }

    function setStatus(text, busy=false){
      statusLine.innerHTML = busy ? `<span class="blink">‚óè</span> ${text}` : `‚óè ${text}`;
    }

    function scrollChatToBottom(){
      chatWrap.scrollTop = chatWrap.scrollHeight;
    }

    function personaById(id){ return personas.find(p=>p.id===id) || personas[0]; }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      })[m]);
    }

    function renderPersonaSelection(){
      [...personaList.querySelectorAll(".persona-card")].forEach(card=>{
        card.classList.toggle("active", card.dataset.personaId === state.selectedPersonaId);
      });
    }

    function addMessage({from="me", text="", personaId=null, chipOverride=null}){
      const p = personaId ? personaById(personaId) : null;
      const isMe = from === "me";
      const who = isMe ? "<%= userName %>" : (p ? p.name : "GouvBrain");
      const chip = chipOverride ? chipOverride : (p ? p.ministry : "syst√®me");

      const msg = document.createElement("div");
      msg.className = "msg" + (isMe ? " me" : "");
      msg.innerHTML = `
        ${isMe ? "" : `
          <div class="avatar" style="width:38px;height:38px;border-radius:14px; box-shadow: 0 0 24px ${(p?.color||"#3b82f6")}33;">
            <span>${p?.avatarEmoji || "üß†"}</span>
          </div>
        `}
        <div style="${isMe ? "max-width:78%;" : ""}">
          <div class="who">${escapeHtml(who)} <span class="chip">${escapeHtml(chip)}</span></div>
          <div class="bubble">${escapeHtml(text)}</div>
        </div>
      `;
      chatWrap.appendChild(msg);
      scrollChatToBottom();
    }

    function setDocMeta({docId, title, pages, status, summary, topics=[]}){
      state.docId = docId ?? state.docId;
      state.docTitle = title ?? state.docTitle;
      state.docPages = (pages ?? state.docPages);
      state.topics = Array.isArray(topics) ? topics : (state.topics || []);

      docIdEl.textContent = state.docId || "‚Äî";
      docTitleEl.textContent = state.docTitle || "‚Äî";
      docPagesEl.textContent = (state.docPages ?? "‚Äî");
      docStatusEl.textContent = status || "Pr√™t";

      docChip.textContent = state.docId ? "Document charg√©" : "Aucun document";

      topicsChip.textContent = `${(state.topics || []).length} th√®mes`;
      if (typeof summary === "string" && summary.trim().length) docSummaryEl.textContent = summary;
    }

    function renderAnalyses(analyses){
      analysisArea.innerHTML = "";
      (analyses || []).forEach(a=>{
        const p = personaById(a.personaId);
        const card = document.createElement("div");
        card.className = "analysis-card";
        card.innerHTML = `
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div style="min-width:0;">
              <h6 style="margin-bottom:6px;">
                <span style="filter: drop-shadow(0 0 18px ${p.color}55);">${p.avatarEmoji||"ü§ñ"}</span>
                ${escapeHtml(p.name)}
              </h6>
              <div class="stance">
                <span style="width:10px;height:10px;border-radius:999px;background:${p.color}; box-shadow:0 0 18px ${p.color}88;"></span>
                <span>${escapeHtml(a.stance || "Perspective & recommandations")}</span>
              </div>
            </div>
            <span class="chip"><i class="bi bi-briefcase"></i> ${escapeHtml(p.ministry)}</span>
          </div>

          ${a.notes ? `<div class="tiny mb-2">${escapeHtml(a.notes)}</div>` : ""}

          <div class="row g-2">
            <div class="col-12">
              <div class="tiny fw-semibold mb-1"><i class="bi bi-exclamation-triangle"></i> Risques</div>
              <ul>${(a.risks||[]).slice(0,8).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>Aucun risque majeur identifi√©</li>"}</ul>
            </div>
            <div class="col-12 mt-2">
              <div class="tiny fw-semibold mb-1"><i class="bi bi-check2-circle"></i> Actions recommand√©es</div>
              <ul>${(a.actions||[]).slice(0,8).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || "<li>Proposer un plan d‚Äôaction</li>"}</ul>
            </div>
          </div>
        `;
        analysisArea.appendChild(card);
      });
    }

    function setLed(el, status){
      el.classList.remove("ok","warn","bad");
      if(status === "ok") el.classList.add("ok");
      else if(status === "warn") el.classList.add("warn");
      else if(status === "bad") el.classList.add("bad");
    }

    async function safeFetchJson(url, opts){
      const res = await fetch(url, opts);
      if(!res.ok){
        const txt = await res.text().catch(()=> "");
        const err = new Error(`HTTP ${res.status} on ${url}`);
        err.status = res.status;
        err.body = txt;
        throw err;
      }
      return await res.json();
    }

    // ----------------------------
    // Text parsing: Decision extraction + contradictions heuristics
    // ----------------------------
    function normalizeText(s){ return (s||"").toLowerCase().replace(/\s+/g," ").trim(); }

    function extractSection(txt, label){
      const re = new RegExp(`${label}\\s*:?([\\s\\S]*?)(\\n\\s*(Risques|Actions|D√©cision|Decision|Indicateurs|KPI|$)\\s*:?)`, "i");
      const m = txt.match(re);
      if(m && m[1]) return m[1].trim();
      return "";
    }

    function extractDecision(txt){
      const m = txt.match(/(D√©cision|Decision)\s*:?([\s\S]*?)(\n\s*(Indicateurs|KPI|$)\s*:?)?/i);
      if(m && m[2]) {
        const line = m[2].trim().split("\n").map(x=>x.trim()).filter(Boolean)[0] || m[2].trim();
        return line.slice(0, 320);
      }
      // fallback: last meaningful sentence
      const lines = (txt||"").split("\n").map(s=>s.trim()).filter(Boolean);
      return (lines[lines.length-1] || "").slice(0, 320);
    }

    const POLARITY = {
      restrict: ["fermer","interdire","suspendre","limiter","couvre-feu","contr√¥ler","renforcer","obligatoire","restriction","sanctionner"],
      relax: ["ouvrir","assouplir","lever","lib√©raliser","autoriser","reprendre","all√©ger","faciliter"],
      spendUp: ["augmenter le budget","financer","mobiliser des fonds","subventionner","acheter","recruter","investir"],
      spendDown: ["r√©duire le budget","geler","couper","rationaliser","√©conomiser","reporter","annuler"]
    };

    function scorePolarity(decision){
      const d = normalizeText(decision);
      const s = {restrict:0, relax:0, spendUp:0, spendDown:0};
      for (const k of Object.keys(POLARITY)){
        for (const w of POLARITY[k]){
          if(d.includes(w)) s[k] += 1;
        }
      }
      return s;
    }

    function detectContradictions(replies){
      // replies: [{personaId, ministry, decision, text}]
      const pairs = [];
      for(let i=0;i<replies.length;i++){
        for(let j=i+1;j<replies.length;j++){
          const a = replies[i], b = replies[j];
          const sa = scorePolarity(a.decision || "");
          const sb = scorePolarity(b.decision || "");

          const conflict =
            (sa.restrict>0 && sb.relax>0) || (sa.relax>0 && sb.restrict>0) ||
            (sa.spendUp>0 && sb.spendDown>0) || (sa.spendDown>0 && sb.spendUp>0);

          if(conflict){
            pairs.push({
              a, b,
              why: [
                ( (sa.restrict>0 && sb.relax>0) || (sa.relax>0 && sb.restrict>0) ) ? "Orientation mesures (restriction vs assouplissement)" : null,
                ( (sa.spendUp>0 && sb.spendDown>0) || (sa.spendDown>0 && sb.spendUp>0) ) ? "Orientation budget (augmentation vs r√©duction)" : null
              ].filter(Boolean).join(" ‚Ä¢ ")
            });
          }
        }
      }
      return pairs.slice(0, 12);
    }

    function renderContradictions(contradictions){
      contradictionArea.innerHTML = "";
      if(!contradictions || contradictions.length === 0) return;

      const card = document.createElement("div");
      card.className = "alert-card";
      card.innerHTML = `
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="fw-bold"><i class="bi bi-shuffle"></i> Contradictions d√©tect√©es</div>
          <span class="chip">${contradictions.length} arbitrage(s)</span>
        </div>
        <div class="tiny mt-2">Ces contradictions sont d√©tect√©es par heuristiques. La Primature synth√©tise ci-dessous.</div>
        <div class="mt-2">
          ${contradictions.map((c, idx)=>`
            <div class="mt-2" style="border-top:1px solid rgba(255,255,255,.08); padding-top:10px;">
              <div class="tiny fw-semibold">${idx+1}. ${escapeHtml(c.why || "Contradiction")}</div>
              <div class="tiny mt-1"><span class="chip">${escapeHtml(c.a.ministry)}</span> ${escapeHtml((c.a.decision||"").slice(0,180))}</div>
              <div class="tiny mt-1"><span class="chip">${escapeHtml(c.b.ministry)}</span> ${escapeHtml((c.b.decision||"").slice(0,180))}</div>
            </div>
          `).join("")}
        </div>
      `;
      contradictionArea.appendChild(card);
    }

    // ----------------------------
    // Real API calls (SAFE)
    // ----------------------------
    async function apiIngest(file){
      const fd = new FormData();
      fd.append("<%= process.env.INGEST_FORM_FIELD || 'file' %>", file);
      return await safeFetchJson(`${API_BASE}/api/gouvbrain/ingest`, { method:"POST", body: fd });
    }

    function buildSystemPromptForPersona(p){
      const pb = MINISTRY_PLAYBOOK[p?.ministry] || {
        angle: p?.focus || "analyse gouvernementale",
        mustMention: ["risques","actions","d√©cision"],
        kpi: ["KPI 1","KPI 2","KPI 3"]
      };

      // Anti-generic guardrails + ministry-specific obligations
      return `
Tu es ${p.name}, ${p.role} du minist√®re ${p.ministry}.
ANGLE OBLIGATOIRE: ${pb.angle}

INTERDICTIONS:
- R√©ponse g√©n√©rique
- "clarifier les objectifs"
- "plan en 3 √©tapes" (sauf si tu fournis des √©tapes concr√®tes, chiffr√©es et responsables)

OBLIGATIONS:
- R√©pondre UNIQUEMENT du point de vue de ${p.ministry}
- Mentionner explicitement: ${pb.mustMention.join(", ")}
- Donner des √©l√©ments concrets: responsables, d√©lais (si possible), moyens
- Ne pas r√©p√©ter les autres minist√®res

FORMAT STRICT:
1) Risques (${p.ministry}) ‚Äî 4 √† 8 points
2) Actions (${p.ministry}) ‚Äî 4 √† 8 points
3) D√©cision recommand√©e ‚Äî 1 ligne claire
4) Indicateurs (3 KPI) ‚Äî parmi: ${pb.kpi.join(" | ")}

Si tu n‚Äôas pas assez d‚Äôinfos, pose 2 questions cibl√©es (uniquement) en fin de r√©ponse.
      `.trim();
    }

    function buildSystemPromptCabinet(){
      // Used only for special aggregate tasks (PM synthesis mostly done via PM persona)
      return `
Tu es le Cabinet IA inter-minist√©riel.
Tu dois produire une sortie structur√©e par minist√®re (Primature, Finances, Int√©rieur, Justice, Sant√©, Num√©rique).
Pas de g√©n√©ralit√©s. Tu dois √™tre actionnable (responsables, d√©lais, m√©triques).
      `.trim();
    }

    // ‚úÖ SAFE: chat goes to /api/ollama/chat (your running server)
    async function apiChat(_docId, message, personaModeVal, personaId){
      const p = (personaModeVal === "single" && personaId) ? personaById(personaId) : null;

      const system = p
        ? buildSystemPromptForPersona(p)
        : buildSystemPromptCabinet();

      const payload = {
        model: "llama3.1:8b",
        stream: false,
        messages: [
          { role: "system", content: system },
          { role: "user", content: message }
        ]
      };

      return await safeFetchJson(`${API_BASE}/api/ollama/chat`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
    }

    // Prime Minister synthesis (uses PM persona, but prompt injects all ministry outputs + contradictions)
    async function apiPrimeMinisterSynthesis(question, replies, contradictions){
      const pm = personaById("pm");

      const pack = replies.map(r => {
        return `### ${r.ministry} (${r.personaName})
D√©cision: ${r.decision || "‚Äî"}
R√©ponse:
${r.text || "‚Äî"}
`;
      }).join("\n");

      const contra = (contradictions || []).map((c, i) => {
        return `- #${i+1} ${c.why || "Contradiction"}: ${c.a.ministry} vs ${c.b.ministry}`;
      }).join("\n") || "Aucune contradiction d√©tect√©e.";

      const pmSystem = `
Tu es ${pm.name}, ${pm.role} √† la ${pm.ministry}. Ton r√¥le: arbitrage final et pilotage de l'ex√©cution.

√Ä partir des r√©ponses minist√©rielles ci-dessous, tu dois:
1) R√©sumer en 8-12 lignes le tableau de situation
2) Lister les contradictions (si pr√©sentes) et proposer un arbitrage clair
3) √âmettre UNE d√©cision du Cabinet (d√©cision finale)
4) Donner un plan d‚Äôex√©cution en 72h / 30 jours / 90 jours (actions + responsables + livrables)
5) D√©finir 6 KPI de suivi (mesurables)

INTERDICTION:
- R√©ponse vague
- "clarifier les objectifs" sans livrables

FORMAT STRICT:
A) Synth√®se
B) Contradictions & arbitrages
C) D√©cision Cabinet (finale)
D) Ex√©cution (72h / 30j / 90j)
E) KPI (6)
      `.trim();

      const pmUser = `
QUESTION INITIALE:
${question}

CONTRADICTIONS D√âTECT√âES:
${contra}

R√âPONSES DES MINIST√àRES:
${pack}
      `.trim();

      const payload = {
        model: "llama3.1:8b",
        stream: false,
        messages: [
          { role: "system", content: pmSystem },
          { role: "user", content: pmUser }
        ]
      };

      return await safeFetchJson(`${API_BASE}/api/ollama/chat`, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
    }

    // ‚úÖ SAFE: Export not implemented -> clean message (no fake downloads)
    async function apiExport(_docId){
      const err = new Error("Export non impl√©ment√© c√¥t√© serveur");
      err.status = 501;
      throw err;
    }

    function pickAnswer(payload){
      return (
        payload?.message?.content ||
        payload?.response ||
        payload?.text ||
        (Array.isArray(payload?.messages) ? payload.messages.map(m => m.text || m.content || "").join("\n") : "")
      ) || "";
    }

    // ----------------------------
    // Live Status Lights (NO MOCK)
    // ----------------------------
    async function pollHealth(){
      // API (main)
      try{
        await fetch(`${API_BASE}/api/health`, { method:"GET" });
        setLed(ledApi, "ok");
      }catch(e){
        setLed(ledApi, "bad");
      }

      // Ollama
      try{
        await fetch(`${API_BASE}/api/ollama/health`, { method:"GET" });
        setLed(ledOllama, "ok");
      }catch(e){
        setLed(ledOllama, "bad");
      }

      // Aidesk
      try{
        await fetch(`${API_BASE}/api/aidesk/health`, { method:"GET" });
        setLed(ledAidesk, "ok");
      }catch(e){
        setLed(ledAidesk, "bad");
      }

      // Firewall
      try{
        await fetch(`${API_BASE}/api/firewall-stats`, { method:"GET" });
        setLed(ledFirewall, "ok");
      }catch(e){
        setLed(ledFirewall, "bad");
      }
    }

    // ----------------------------
    // UI interactions
    // ----------------------------
    personaList.addEventListener("click", (e)=>{
      const card = e.target.closest(".persona-card");
      if(!card) return;
      state.selectedPersonaId = card.dataset.personaId;
      renderPersonaSelection();

      if (personaMode.value === "single"){
        const p = personaById(state.selectedPersonaId);
        modeChip.textContent = `Mode: ${p.name}`;
      }
    });

    personaMode.addEventListener("change", ()=>{
      if(personaMode.value === "cabinet"){
        modeChip.textContent = "Mode: Cabinet";
      }else{
        const p = personaById(state.selectedPersonaId);
        modeChip.textContent = `Mode: ${p.name}`;
      }
    });

    btnPick.addEventListener("click", ()=> pdfInput.click());

    pdfInput.addEventListener("change", ()=>{
      if(!pdfInput.files || !pdfInput.files[0]) return;
      setSelectedFile(pdfInput.files[0]);
    });

    function setSelectedFile(file){
      if(!file) return;
      if(file.type !== "application/pdf"){
        addMessage({from:"ai", text:"‚ö†Ô∏è Veuillez s√©lectionner un fichier PDF (application/pdf)."});
        return;
      }
      state.file = file;
      fileName.textContent = file.name;
      fileSize.textContent = fmtBytes(file.size);
      btnIngest.disabled = false;
      progBar.style.width = "0%";
      setStatus("Fichier pr√™t ‚Äî cliquez Ingest", false);
    }

    // Drag/drop
    ["dragenter","dragover"].forEach(ev=>{
      dropzone.addEventListener(ev, (e)=>{
        e.preventDefault();
        dropzone.classList.add("dragover");
      });
    });
    ["dragleave","drop"].forEach(ev=>{
      dropzone.addEventListener(ev, (e)=>{
        e.preventDefault();
        dropzone.classList.remove("dragover");
      });
    });
    dropzone.addEventListener("drop", (e)=>{
      const file = e.dataTransfer.files?.[0];
      if(file) setSelectedFile(file);
    });
    dropzone.addEventListener("click", (e)=>{
      if(e.target.closest("button")) return;
      pdfInput.click();
    });

    btnIngest.addEventListener("click", async ()=>{
      if(!state.file) return;

      setStatus("Ingestion du PDF‚Ä¶", true);
      docStatusEl.textContent = "Ingestion‚Ä¶";
      progBar.style.width = "18%";

      try{
        const ingest = await apiIngest(state.file);
        progBar.style.width = "60%";

        setDocMeta({
          docId: ingest.docId,
          title: ingest.title || state.file.name,
          pages: ingest.pages,
          status: "Ingest√©",
          summary: ingest.summary,
          topics: ingest.keyTopics || []
        });

        addMessage({from:"ai", text:`‚úÖ Document ing√©r√©: ${ingest.title || state.file.name} (${ingest.pages ?? "?"} pages). Lancement de l‚Äôanalyse‚Ä¶`});
        progBar.style.width = "80%";

        // Auto-run analysis after ingestion (client-side)
        await runAnalyzeAll();

        progBar.style.width = "100%";
        setTimeout(()=> progBar.style.width = "0%", 900);
        setStatus("Pr√™t", false);
      }catch(err){
        console.error(err);
        docStatusEl.textContent = "Erreur";
        addMessage({from:"ai", text:`‚ùå √âchec ingestion. Endpoint /api/gouvbrain/ingest indisponible ou erreur serveur. (${err.message})`});
        setStatus("Erreur ingestion", false);
        progBar.style.width = "0%";
      }
    });

    // ‚úÖ SAFE: Analyze All runs client-side using /api/ollama/chat
    async function runAnalyzeAll(){
      if(!state.docId){
        addMessage({from:"ai", text:"‚ÑπÔ∏è DocID absent. Je lance quand m√™me une analyse g√©n√©rale (sans r√©f√©rence document)."});
      }

      setStatus("Analyse multi-personas‚Ä¶", true);
      docStatusEl.textContent = "Analyse‚Ä¶";
      analysisArea.innerHTML = "";
      contradictionArea.innerHTML = "";

      const analyses = [];

      for (const p of personas){
        try{
          const q = "Analyse le dossier et propose: 6 risques, 6 actions, 1 d√©cision recommand√©e, et 3 KPI. R√©ponds STRICTEMENT au format Risques/Actions/D√©cision/Indicateurs.";
          const out = await apiChat(state.docId, q, "single", p.id);
          const txt = pickAnswer(out);

          const risksBlock = (txt.match(/Risques?\s*:?([\s\S]*?)(Actions?|D√©cision|Decision|Indicateurs|KPI|$)/i)?.[1] || "");
          const actionsBlock = (txt.match(/Actions?\s*:?([\s\S]*?)(D√©cision|Decision|Indicateurs|KPI|$)/i)?.[1] || "");

          const risks = risksBlock.split("\n").map(s=>s.replace(/^[-‚Ä¢\d.)\s]+/,"").trim()).filter(Boolean).slice(0,8);
          const actions = actionsBlock.split("\n").map(s=>s.replace(/^[-‚Ä¢\d.)\s]+/,"").trim()).filter(Boolean).slice(0,8);

          analyses.push({
            personaId: p.id,
            stance: "Analyse",
            risks: risks.length ? risks : ["Voir notes (r√©ponse compl√®te)"],
            actions: actions.length ? actions : ["Voir notes (r√©ponse compl√®te)"],
            notes: txt
          });
        }catch(e){
          analyses.push({ personaId: p.id, stance:"Erreur", risks:[], actions:[], notes:`Erreur: ${e.message}` });
        }
      }

      renderAnalyses(analyses);
      docStatusEl.textContent = "Analyse pr√™te";
      addMessage({from:"ai", text:"üßæ Analyses g√©n√©r√©es (client-side). Posez vos questions dans le chat pour arbitrages & plan d‚Äôaction."});
      setStatus("Pr√™t", false);
    }

    btnAnalyzeAll.addEventListener("click", runAnalyzeAll);

    btnSend.addEventListener("click", sendChat);
    chatInput.addEventListener("keydown", (e)=>{
      if(e.key === "Enter") sendChat();
    });

    // ----------------------------
    // AUTOMATIC MINISTRY ROUTING (Cabinet mode)
    // + Contradiction detection
    // + Prime Minister synthesis
    // ----------------------------
    async function sendChat(){
      const text = (chatInput.value || "").trim();
      if(!text) return;

      addMessage({from:"me", text});
      chatInput.value = "";

      const mode = personaMode.value;

      try{
        if(mode === "single"){
          setStatus("Persona en r√©flexion‚Ä¶", true);
          const personaId = state.selectedPersonaId;
          const payload = await apiChat(state.docId, text, "single", personaId);
          const answer = pickAnswer(payload);
          addMessage({from:"ai", personaId, text: answer || "‚Äî"});
          setStatus("Pr√™t", false);
          return;
        }

        // Cabinet: route to each ministry automatically
        setStatus("Cabinet IA (multi-minist√®res)‚Ä¶", true);
        contradictionArea.innerHTML = "";

        const cabinetReplies = [];

        // (1) Collect each ministry reply
        for(const p of personas){
          setStatus(`Cabinet IA: ${p.ministry}‚Ä¶`, true);
          const payload = await apiChat(state.docId, text, "single", p.id);
          const answer = pickAnswer(payload);

          addMessage({from:"ai", personaId: p.id, text: answer || "‚Äî"});

          const decision = extractDecision(answer || "");
          cabinetReplies.push({
            personaId: p.id,
            personaName: p.name,
            ministry: p.ministry,
            text: answer || "",
            decision
          });
        }

        state.lastCabinetReplies = cabinetReplies;

        // (2) Detect contradictions (heuristics)
        const contradictions = detectContradictions(cabinetReplies);
        renderContradictions(contradictions);

        // (3) PM synthesis (final arbitration)
        setStatus("Primature: arbitrage & synth√®se‚Ä¶", true);
        const pmPayload = await apiPrimeMinisterSynthesis(text, cabinetReplies, contradictions);
        const pmAnswer = pickAnswer(pmPayload);

        // show as PM message
        addMessage({from:"ai", personaId:"pm", text: pmAnswer || "‚Äî", chipOverride: "Primature ‚Ä¢ Synth√®se"});
        setStatus("Pr√™t", false);

      }catch(err){
        console.error(err);
        addMessage({from:"ai", text:`‚ùå Chat API indisponible. V√©rifiez /api/ollama/chat. (${err.message})`});
        setStatus("Erreur chat", false);
      }
    }

    // ‚úÖ SAFE: Summarize uses cabinet routing + PM synthesis
    btnSummarize.addEventListener("click", async ()=>{
      const question = "G√©n√®re un r√©sum√© ex√©cutif (10 lignes) + 6 th√®mes + 6 d√©cisions propos√©es. Format strict et chiffrable.";

      if(!state.docId){
        addMessage({from:"ai", text:"‚ÑπÔ∏è Pas de DocID: je peux r√©sumer √† partir de votre demande, mais l‚Äôingestion PDF est recommand√©e."});
      }

      setStatus("R√©sum√© ex√©cutif (multi-minist√®res)‚Ä¶", true);
      try{
        // collect per-ministry summaries
        const replies = [];
        for(const p of personas){
          setStatus(`R√©sum√©: ${p.ministry}‚Ä¶`, true);
          const out = await apiChat(state.docId, question, "single", p.id);
          const txt = pickAnswer(out);
          replies.push({ personaId:p.id, personaName:p.name, ministry:p.ministry, text: txt, decision: extractDecision(txt) });
        }

        const contradictions = detectContradictions(replies);
        renderContradictions(contradictions);

        // PM synthesis for summary
        setStatus("Primature: synth√®se du r√©sum√©‚Ä¶", true);
        const pmOut = await apiPrimeMinisterSynthesis("R√©sum√© ex√©cutif du dossier", replies, contradictions);
        const pmTxt = pickAnswer(pmOut);

        // Put into right panel summary field
        if (pmTxt && typeof pmTxt === "string") docSummaryEl.textContent = pmTxt;

        addMessage({from:"ai", personaId:"pm", text:"üìå R√©sum√© ex√©cutif mis √† jour (synth√®se Primature).", chipOverride:"Primature"});
        setStatus("Pr√™t", false);
      }catch(err){
        console.error(err);
        addMessage({from:"ai", text:`‚ùå Impossible de g√©n√©rer le r√©sum√© via /api/ollama/chat. (${err.message})`});
        setStatus("Erreur r√©sum√©", false);
      }
    });

    // ‚úÖ SAFE: Export disabled unless you implement a real endpoint later
    btnExport.addEventListener("click", async ()=>{
      addMessage({from:"ai", text:"‚ÑπÔ∏è Export non disponible pour l‚Äôinstant (aucun endpoint serveur). Impl√©mentez /api/gouvbrain/export si n√©cessaire."});
    });

    btnClear.addEventListener("click", ()=>{
      state.docId = null; state.docTitle = null; state.docPages = null; state.topics = [];
      state.file = null;
      state.lastCabinetReplies = [];

      pdfInput.value = "";
      fileName.textContent = "Aucun fichier";
      fileSize.textContent = "‚Äî";
      btnIngest.disabled = true;
      progBar.style.width = "0%";

      setDocMeta({
        docId:null,
        title:null,
        pages:null,
        status:"En attente",
        summary:"D√©posez un PDF pour g√©n√©rer un r√©sum√© et activer les analyses multi-personas.",
        topics:[]
      });
      analysisArea.innerHTML = "";
      contradictionArea.innerHTML = "";
      docChip.textContent = "Aucun document";

      // keep first system message only
      const keep = chatWrap.querySelector(".msg");
      chatWrap.innerHTML = "";
      if(keep) chatWrap.appendChild(keep);

      addMessage({from:"ai", text:"‚ôªÔ∏è Session r√©initialis√©e. D√©posez un nouveau PDF."});
      setStatus("Pr√™t", false);
    });

    // ----------------------------
    // Init
    // ----------------------------
    function init(){
      renderPersonaSelection();
      setDocMeta({docId:null, title:null, pages:null, status:"En attente"});
      setStatus("Pr√™t", false);

      // Health polling
      pollHealth();
      setInterval(pollHealth, 7000);
    }
    init();
  </script>
</body>
</html>