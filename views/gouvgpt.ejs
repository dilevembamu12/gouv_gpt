<!-- 
  GouvBrain Frontend - UI/UX Refonte "Ultra Modern"
  Vue Salon avec s√©lection de Personas et Partage RAG
-->
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GouvBrain ‚Ä¢ Conseil des Ministres IA</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    :root { 
        /* Palette "Deep Space" */
        --bg-body: #09090b;       /* Fond principal tr√®s sombre */
        --bg-sidebar: #0f1016;    /* Sidebar l√©g√®rement plus claire */
        --bg-surface: #18181b;    /* Cards, Modals */
        --bg-input: #27272a;      /* Input fields */
        
        --accent-primary: #3b82f6; /* Bleu vibrant */
        --accent-glow: rgba(59, 130, 246, 0.15);
        
        --text-primary: #f4f4f5;
        --text-secondary: #a1a1aa;
        --text-tertiary: #71717a;
        
        --border-subtle: #27272a;
        
        --font-main: 'Plus Jakarta Sans', system-ui, -apple-system, sans-serif;
    }
    
    body { 
        background-color: var(--bg-body); 
        color: var(--text-primary); 
        font-family: var(--font-main);
        height: 100vh; 
        overflow: hidden; 
        display: flex;
        flex-direction: column;
        line-height: 1.6;
    }

    /* --- Utilities --- */
    .glass-panel {
        background: rgba(24, 24, 27, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.05);
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg-input); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }

    /* --- Modale --- */
    .modal-content { 
        background-color: var(--bg-surface); 
        border: 1px solid var(--border-subtle); 
        color: var(--text-primary);
        border-radius: 24px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    .modal-header { border-bottom: 1px solid var(--border-subtle); padding: 1.5rem 2rem; }
    .modal-body { padding: 2rem; }
    .modal-footer { border-top: 1px solid var(--border-subtle); padding: 1.5rem 2rem; }
    
    .form-control, .form-control:focus {
        background-color: var(--bg-body);
        border: 1px solid var(--border-subtle);
        color: var(--text-primary);
        border-radius: 12px;
        padding: 0.8rem 1rem;
    }
    .form-control:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* --- Header --- */
    header {
        background-color: var(--bg-sidebar);
        border-bottom: 1px solid var(--border-subtle);
        height: 70px;
        flex-shrink: 0;
    }

    /* --- Layout --- */
    .app-container { 
        flex: 1; 
        display: flex; 
        overflow: hidden; 
        position: relative;
    }

    /* --- Sidebar --- */
    .sidebar { 
        width: 320px; 
        background-color: var(--bg-sidebar); 
        border-right: 1px solid var(--border-subtle); 
        display: flex;
        flex-direction: column;
        z-index: 10;
    }

    .persona-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 4px;
        transition: all 0.2s;
        border: 1px solid transparent;
        cursor: default;
    }
    .persona-list-item:hover { background: rgba(255,255,255,0.03); }
    .persona-list-item.active { 
        background: rgba(59, 130, 246, 0.1); 
        border-color: rgba(59, 130, 246, 0.2);
    }
    .persona-avatar {
        width: 40px; height: 40px;
        border-radius: 10px;
        background: var(--bg-surface);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.25rem;
        border: 1px solid var(--border-subtle);
        flex-shrink: 0;
    }

    /* --- Chat Area --- */
    .chat-area { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        background: radial-gradient(circle at 50% -20%, #1e1b4b 0%, var(--bg-body) 60%);
        position: relative;
        overflow-y: auto;
        scroll-behavior: smooth;
    }
    
    .chat-wrap {
        padding: 2rem 15%; /* Centered reading experience */
        display: flex;
        flex-direction: column;
        gap: 2rem;
        min-height: 0; /* Important for flex child scrolling */
    }
    @media (max-width: 1400px) { .chat-wrap { padding: 2rem 5%; } }

    /* --- Messages --- */
    .message-group {
        display: flex;
        gap: 1.5rem;
        animation: slideUp 0.3s ease-out;
    }
    .message-group.me { flex-direction: row-reverse; }

    .message-avatar {
        width: 36px; height: 36px;
        border-radius: 8px;
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        display: flex; align-items: center; justify-content: center;
        font-size: 1.1rem;
        margin-top: 4px;
        flex-shrink: 0;
    }

    .message-content {
        max-width: 75%;
        min-width: 200px;
    }
    .message-bubble {
        padding: 1rem 1.25rem;
        border-radius: 16px;
        font-size: 1rem;
        line-height: 1.6;
        position: relative;
    }

    /* Bot Style */
    .message-group.bot .message-bubble {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-top-left-radius: 4px;
        color: var(--text-secondary);
    }
    .message-sender {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--text-tertiary);
        display: flex; align-items: center; gap: 8px;
    }

    /* User Style */
    .message-group.me .message-bubble {
        background: var(--accent-primary);
        color: white;
        border-top-right-radius: 4px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- Input Area --- */
    .input-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        padding: 0 2rem 2rem 2rem;
        position: sticky;
        bottom: 0;
        background: transparent;
        z-index: 20;
    }

    .input-box {
        background: var(--bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 8px;
        display: flex;
        align-items: flex-end;
        box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
        transition: border-color 0.2s;
    }
    .input-box:focus-within {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 1px var(--accent-primary), 0 -10px 40px rgba(0,0,0,0.3);
    }

    .chat-textarea {
        background: transparent;
        border: none;
        color: var(--text-primary);
        width: 100%;
        padding: 12px 16px;
        resize: none;
        outline: none;
        min-height: 48px;
        max-height: 200px;
        font-family: inherit;
        font-size: 1rem;
    }
    .chat-textarea::placeholder { color: var(--text-tertiary); }

    .action-btn {
        width: 40px; height: 40px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text-secondary);
        display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
        margin-bottom: 4px;
        margin-right: 4px;
    }
    .action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
    .send-btn {
        background: var(--accent-primary);
        color: white;
    }
    .send-btn:hover { background: #2563eb; transform: scale(1.05); }

    /* --- Empty State --- */
    .empty-state {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        padding-top: 10vh;
        color: var(--text-tertiary); text-align: center;
    }
    .empty-icon {
        width: 80px; height: 80px;
        background: rgba(255,255,255,0.03);
        border-radius: 20px;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-subtle);
    }

    /* --- Checkbox Card --- */
    .persona-select-card {
        background: var(--bg-body);
        border: 1px solid var(--border-subtle);
        border-radius: 16px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    .persona-select-card:hover { border-color: var(--text-secondary); transform: translateY(-2px); }
    .form-check-input:checked + .persona-select-card {
        border-color: var(--accent-primary);
        background: rgba(59, 130, 246, 0.05);
    }
    .form-check-input:checked + .persona-select-card::after {
        content: "\F26E"; /* Bootstrap check icon */
        font-family: "bootstrap-icons";
        position: absolute; top: 10px; right: 10px;
        color: var(--accent-primary); font-size: 1.2rem;
    }

    /* Formating markdown simulation */
    .md-content ul { padding-left: 1.2rem; margin-bottom: 0.5rem; }
    .md-content li { margin-bottom: 0.25rem; }
    .md-content strong { color: #fff; font-weight: 600; }
    .md-content h1, .md-content h2, .md-content h3 { font-size: 1.1rem; font-weight: 700; margin-top: 1rem; color: #fff; }
  
    

  :root { 
        --bg-body: #09090b; --bg-sidebar: #0f1016; --bg-surface: #18181b; --text-primary: #f4f4f5; 
        --accent-primary: #3b82f6; --font-main: 'Plus Jakarta Sans', sans-serif;
    }
    body { background-color: var(--bg-body); color: var(--text-primary); font-family: var(--font-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
    
    /* Loader Sp√©cifique */
    .thinking-dots::after {
        content: ' .'; animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots { 0%, 20% { content: ' .'; } 40% { content: ' ..'; } 60% { content: ' ...'; } 80%, 100% { content: ' ....'; } }

    /* Layout Chat */
    .chat-area { flex: 1; overflow-y: auto; background: radial-gradient(circle at 50% -20%, #172554 0%, var(--bg-body) 60%); padding: 2rem 15%; display: flex; flex-direction: column; gap: 1.5rem; }
    .sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid #27272a; display: flex; flex-direction: column; }
    
    /* Input Area */
    .input-container { max-width: 800px; margin: 0 auto; width: 100%; padding-bottom: 2rem; position: sticky; bottom: 0; }
    .input-box { background: var(--bg-surface); border: 1px solid #27272a; border-radius: 16px; padding: 0.8rem; display: flex; gap: 0.5rem; align-items: flex-end; box-shadow: 0 -10px 30px rgba(0,0,0,0.5); }
    textarea { background: transparent; border: none; color: white; width: 100%; resize: none; outline: none; font-family: inherit; }
    
    /* Messages */
    .msg { display: flex; gap: 1rem; animation: slideIn 0.3s ease; }
    .msg.me { flex-direction: row-reverse; }
    .msg-content { padding: 1rem 1.25rem; border-radius: 16px; line-height: 1.6; position: relative; max-width: 80%; }
    .msg.bot .msg-content { background: var(--bg-surface); border: 1px solid #27272a; color: #e2e8f0; border-top-left-radius: 4px; }
    .msg.me .msg-content { background: var(--accent-primary); color: white; border-top-right-radius: 4px; }
    .avatar { width: 36px; height: 36px; border-radius: 8px; background: #27272a; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }
    
    @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body>

  <!-- MODAL -->
  <div class="modal fade" id="roomModal" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content" style="background: #18181b; border: 1px solid #3f3f46; color: white;">
        <div class="modal-header border-0"><h4><i class="bi bi-cpu me-2"></i>Configuration Conseil IA</h4></div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="text-secondary small fw-bold mb-1">SUJET DE LA SESSION</label>
                <input type="text" id="roomNameInput" class="form-control bg-dark text-white border-secondary" placeholder="ex: Strat√©gie √ânerg√©tique 2030">
            </div>
            <label class="text-secondary small fw-bold mb-2">MINIST√àRES CONVOQU√âS</label>
            <div class="row g-2" id="personaSelector"></div>
        </div>
        <div class="modal-footer border-0">
            <button class="btn btn-primary w-100 py-2 fw-bold" onclick="createRoom()">Ouvrir la Session</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appShell" class="d-flex h-100" style="opacity:0; pointer-events:none; transition: opacity 0.5s;">
    <!-- SIDEBAR -->
    <div class="sidebar p-3">
        <div class="mb-4">
            <h5 class="fw-bold text-white mb-0">GouvBrain</h5>
            <div class="small text-secondary" id="roomTitleDisplay">Chargement...</div>
        </div>
        <h6 class="text-secondary small fw-bold text-uppercase mb-3">Cabinet Actif</h6>
        <div id="activePersonasCol" class="d-flex flex-column gap-2 overflow-auto"></div>
    </div>

    <!-- CHAT -->
    <div style="flex:1; display:flex; flex-direction:column; position:relative;">
        <div id="chatWrap" class="chat-area">
            <div class="text-center text-muted mt-5">
                <i class="bi bi-stars fs-1 mb-3 d-block"></i>
                <h3>Le conseil est ouvert</h3>
                <p>Interrogez les minist√®res ou d√©posez un document pour analyse.</p>
            </div>
        </div>

        <div class="input-container">
            <div class="text-center small text-secondary mb-2" id="statusIndicator"></div>
            <div class="input-box">
                <input type="file" id="ragInput" hidden onchange="uploadRag()">
                <button class="btn btn-sm btn-link text-secondary" onclick="document.getElementById('ragInput').click()"><i class="bi bi-paperclip fs-5"></i></button>
                <textarea id="chatInput" rows="1" placeholder="Posez votre question au cabinet..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                <button class="btn btn-primary btn-sm rounded-3 px-3 py-2" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentRoomId = null;
    let allPersonas = [];
    let activePersonas = [];

    // --- INIT ---
    async function init() {
        const res = await fetch('/api/admin/personas');
        const data = await res.json();
        allPersonas = data.personas;

        document.getElementById('personaSelector').innerHTML = allPersonas.map(p => `
            <div class="col-md-6">
                <div class="form-check bg-black bg-opacity-25 p-3 rounded border border-secondary border-opacity-25">
                    <input class="form-check-input" type="checkbox" value="${p.id}" id="p_${p.id}" checked>
                    <label class="form-check-label d-flex align-items-center gap-2" for="p_${p.id}">
                        <span class="fs-4">${p.avatarEmoji}</span>
                        <div>
                            <div class="fw-bold text-white">${p.ministry}</div>
                            <div class="small text-secondary">${p.name}</div>
                        </div>
                    </label>
                </div>
            </div>
        `).join('');

        new bootstrap.Modal(document.getElementById('roomModal')).show();
    }

    // --- CREATE ROOM ---
    async function createRoom() {
        const name = document.getElementById('roomNameInput').value;
        const ids = [...document.querySelectorAll('#personaSelector input:checked')].map(c => c.value);
        
        const res = await fetch('/api/rooms', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ name, selectedPersonaIds: ids })
        });
        const data = await res.json();
        
        if(data.ok){
            currentRoomId = data.room.id;
            activePersonas = allPersonas.filter(p => ids.includes(p.id));
            
            document.getElementById('roomTitleDisplay').innerText = data.room.name;
            renderSidebar();
            
            document.querySelector('.modal.show').classList.remove('show');
            document.querySelector('.modal-backdrop').remove();
            document.getElementById('roomModal').style.display = 'none';
            document.getElementById('appShell').style.opacity = 1;
            document.getElementById('appShell').style.pointerEvents = 'all';
        }
    }

    function renderSidebar(){
        document.getElementById('activePersonasCol').innerHTML = activePersonas.map(p => `
            <div class="d-flex align-items-center gap-2 p-2 rounded bg-white bg-opacity-5">
                <div class="avatar bg-transparent">${p.avatarEmoji}</div>
                <div class="overflow-hidden">
                    <div class="fw-bold small text-white text-truncate">${p.ministry}</div>
                    <div class="text-secondary" style="font-size:0.7rem;">${p.name}</div>
                </div>
            </div>
        `).join('');
    }

    // --- UPLOAD ---
    async function uploadRag(){
        const file = document.getElementById('ragInput').files[0];
        if(!file) return;

        const status = document.getElementById('statusIndicator');
        status.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> S√©curisation de ${file.name}...`;

        const fd = new FormData(); fd.append('file', file);
        try {
            const res = await fetch(`/api/rooms/${currentRoomId}/ingest`, {method:'POST', body:fd});
            const d = await res.json();
            if(d.ok) {
                status.innerText = "Document analys√© et ajout√© au contexte.";
                addMessage("system", `üìÇ <strong>Document ajout√© :</strong> ${file.name}`);
            } else throw new Error(d.error);
        } catch(e) {
            status.innerText = "Erreur upload.";
            alert(e.message);
        }
    }

    // --- CHAT (ORCHESTR√â PAR N8N) ---
    async function sendMessage(){
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if(!text) return;

        input.value = '';
        input.style.height = 'auto';

        // 1. Message Utilisateur
        addMessage("me", text);

        // 2. Indicateur de r√©flexion
        const status = document.getElementById('statusIndicator');
        status.innerHTML = `<span class="thinking-dots">Le Cabinet d√©lib√®re</span>`;

        try {
            // Appel Unique au Backend (qui relaie √† n8n)
            const res = await fetch('/api/chat/n8n', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    roomId: currentRoomId,
                    message: text,
                    activeMinistriesIds: activePersonas.map(p => p.id), // On envoie tous les actifs par d√©faut
                    model: "gpt-4o"
                })
            });

            const backendRes = await res.json();

            if (backendRes.ok) {
                // n8n peut renvoyer { response: "Texte unique" } ou { responses: [ {ministry:..., text:...} ] }
                // Adaptez selon la sortie r√©elle de votre workflow n8n
                const data = backendRes.data; 

                if (data.response) {
                    // Cas simple : R√©ponse texte unique (ex: Synth√®se du PM)
                    addMessage("bot", data.response, { name: "Cabinet (Synth√®se)", avatar: "üèõÔ∏è" });
                } else if (Array.isArray(data.responses)) {
                    // Cas complexe : R√©ponses multiples
                    data.responses.forEach(r => {
                        const p = activePersonas.find(ap => ap.ministry === r.ministry);
                        addMessage("bot", r.text, { 
                            name: r.ministry || "Minist√®re", 
                            avatar: p ? p.avatarEmoji : "üèõÔ∏è" 
                        });
                    });
                } else {
                     // Fallback si format inconnu
                     addMessage("bot", JSON.stringify(data), { name: "Syst√®me", avatar: "‚öôÔ∏è" });
                }

            } else {
                throw new Error(backendRes.error || "Erreur inconnue");
            }

        } catch (e) {
            console.error(e);
            addMessage("system", `‚ùå Erreur de communication : ${e.message}`);
        } finally {
            status.innerHTML = '';
        }
    }

    function addMessage(type, text, meta = {}) {
        const wrap = document.getElementById('chatWrap');
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        
        // Supprimer l'√©tat vide si pr√©sent
        if(wrap.querySelector('.text-center.text-muted')) wrap.innerHTML = '';

        let content = text.replace(/\n/g, '<br>');
        // Simple bold formatting
        content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

        if(type === 'me') {
            div.innerHTML = `<div class="msg-content">${content}</div>`;
        } else if(type === 'system') {
            div.className = "text-center my-3 small text-secondary opacity-75";
            div.innerHTML = content;
        } else {
            div.innerHTML = `
                <div class="avatar">${meta.avatar || 'ü§ñ'}</div>
                <div style="max-width:85%">
                    <div class="small fw-bold text-secondary mb-1 ms-1">${meta.name || 'IA'}</div>
                    <div class="msg-content">${content}</div>
                </div>
            `;
        }
        wrap.appendChild(div);
        wrap.scrollTop = wrap.scrollHeight;
    }

    // Enter to send
    document.getElementById('chatInput').addEventListener('keypress', e => {
        if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    init();
  </script>
</body>
</html>