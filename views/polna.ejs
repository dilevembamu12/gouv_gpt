<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>AIDesk — PNH Polna Command & Operations</title>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <style>
        :root {
            --bg: #071019;
            --panel: #0b1826;
            --panel2: #0e2135;
            --text: #dbe7ff;
            --muted: #95a7c6;
            --accent: #37d3ff;
            --good: #39d98a;
            --warn: #ffc44d;
            --bad: #ff5b6b;
            --chip: #102844;
            --line: rgba(255,255,255,.08);
            --shadow: 0 16px 60px rgba(0,0,0,.35);
            --radius: 18px;
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            font-family: var(--sans);
            background: radial-gradient(1200px 900px at 20% 0%, rgba(55,211,255,.18), transparent 55%),
                       radial-gradient(1000px 800px at 70% 30%, rgba(57,217,138,.14), transparent 55%),
                       radial-gradient(1000px 800px at 50% 120%, rgba(255,91,107,.10), transparent 55%),
                       var(--bg);
            color: var(--text);
        }
        
        header {
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            border-bottom: 1px solid var(--line);
            background: linear-gradient(180deg, rgba(11,24,38,.92), rgba(11,24,38,.65));
            backdrop-filter: blur(10px);
            gap: 12px;
            min-width: 0;
            flex-shrink: 0;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 800;
            letter-spacing: .3px;
            min-width: 0;
        }
        
        .brand > div {
            min-width: 0;
        }
        
        .brand small {
            color: var(--muted);
            font-weight: 600;
        }
        
        .brand .sub {
            color: var(--muted);
            font-size: 12px;
            margin-top: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 72vw;
        }
        
        .dot {
            width: 12px;
            height: 12px;
            border-radius: 999px;
            background: var(--accent);
            box-shadow: 0 0 0 6px rgba(55,211,255,.12);
            flex: 0 0 auto;
        }
        
        .top-actions {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            border-radius: 999px;
            color: var(--text);
            font-size: 12.5px;
            white-space: nowrap;
        }
        
        .pill b {
            font-family: var(--mono);
            font-size: 12px;
            font-weight: 700;
        }
        
        .btn {
            cursor: pointer;
            border: none;
            border-radius: 12px;
            padding: 10px 12px;
            background: linear-gradient(180deg, rgba(55,211,255,.2), rgba(55,211,255,.08));
            border: 1px solid rgba(55,211,255,.28);
            color: var(--text);
            font-weight: 700;
            box-shadow: 0 10px 22px rgba(0,0,0,.18);
            white-space: nowrap;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn.secondary {
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            font-weight: 700;
        }
        
        .btn.danger {
            background: linear-gradient(180deg, rgba(255,91,107,.22), rgba(255,91,107,.08));
            border: 1px solid rgba(255,91,107,.30);
        }
        
        main {
            height: calc(100vh - 64px);
            display: grid;
            grid-template-columns: 1.35fr 1fr;
            gap: 14px;
            padding: 14px;
            min-height: 0;
            overflow: hidden;
        }
        
        .card {
            background: linear-gradient(180deg, rgba(11,24,38,.92), rgba(11,24,38,.72));
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .card-hd {
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--line);
            background: rgba(14,33,53,.40);
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .card-hd h3 {
            margin: 0;
            font-size: 14px;
            letter-spacing: .2px;
        }
        
        .card-bd {
            padding: 12px 14px;
            overflow: auto;
            min-height: 0;
            flex: 1;
        }
        
        #map {
            height: 100%;
            width: 100%;
            min-height: 300px;
        }
        
        .map-wrap {
            flex: 1;
            position: relative;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        
        .map-toolbar {
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            pointer-events: none;
        }
        
        .map-toolbar > * {
            pointer-events: auto;
        }
        
        .input {
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px 12px;
            color: var(--text);
            outline: none;
            min-width: 200px;
        }
        
        .select {
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            border-radius: 12px;
            padding: 10px 12px;
            color: var(--text);
            outline: none;
        }
        
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 8px 10px;
            font-size: 12px;
            color: var(--text);
            white-space: nowrap;
        }
        
        .kpi {
            display: flex;
            gap: 10px;
            align-items: stretch;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        
        .kpi .box {
            flex: 1;
            min-width: 160px;
            background: rgba(16,40,68,.45);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px 12px;
        }
        
        .kpi .box .lbl {
            color: var(--muted);
            font-size: 12px;
        }
        
        .kpi .box .val {
            font-family: var(--mono);
            font-weight: 800;
            font-size: 18px;
            margin-top: 6px;
        }
        
        .kpi .box .tag {
            font-size: 11px;
            color: var(--muted);
            margin-top: 6px;
        }
        
        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .section {
            background: rgba(16,40,68,.35);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 12px;
            min-width: 0;
        }
        
        .section h4 {
            margin: 0 0 8px 0;
            font-size: 13px;
        }
        
        .small {
            font-size: 12px;
            color: var(--muted);
        }
        
        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            min-width: 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12.5px;
        }
        
        th, td {
            padding: 10px 10px;
            border-bottom: 1px solid rgba(255,255,255,.06);
            text-align: left;
            vertical-align: top;
        }
        
        th {
            color: var(--muted);
            font-weight: 700;
            position: sticky;
            top: 0;
            background: rgba(11,24,38,.92);
            z-index: 1;
        }
        
        .mono {
            font-family: var(--mono);
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 9px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(16,40,68,.5);
            font-size: 11.5px;
            white-space: nowrap;
        }
        
        .s-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }
        
        .s-good {
            background: var(--good);
            box-shadow: 0 0 0 6px rgba(57,217,138,.10);
        }
        
        .s-warn {
            background: var(--warn);
            box-shadow: 0 0 0 6px rgba(255,196,77,.10);
        }
        
        .s-bad {
            background: var(--bad);
            box-shadow: 0 0 0 6px rgba(255,91,107,.10);
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .tab {
            cursor: pointer;
            user-select: none;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(16,40,68,.45);
            font-size: 12px;
            color: var(--text);
            white-space: nowrap;
        }
        
        .tab.active {
            background: linear-gradient(180deg, rgba(55,211,255,.22), rgba(55,211,255,.08));
            border: 1px solid rgba(55,211,255,.32);
        }
        
        .split {
            display: grid;
            grid-template-rows: 1fr auto;
            gap: 10px;
            height: 100%;
            min-height: 0;
        }
        
        .chat {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            gap: 10px;
        }
        
        .chat-log {
            flex: 1;
            overflow: auto;
            background: rgba(16,40,68,.22);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px;
            min-height: 160px;
        }
        
        .msg {
            padding: 10px 10px;
            border-radius: 14px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,.06);
            background: rgba(11,24,38,.55);
            white-space: pre-wrap;
        }
        
        .msg.me {
            background: rgba(55,211,255,.10);
            border: 1px solid rgba(55,211,255,.18);
        }
        
        .msg .meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--muted);
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .chat-input textarea {
            flex: 1;
            min-height: 46px;
            max-height: 140px;
            resize: vertical;
            background: rgba(16,40,68,.55);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px 12px;
            color: var(--text);
            outline: none;
        }
        
        .hint {
            color: var(--muted);
            font-size: 11.5px;
            line-height: 1.35;
        }
        
        .drawer {
            position: fixed;
            top: 64px;
            right: 14px;
            width: min(520px, calc(100vw - 28px));
            height: calc(100vh - 78px);
            background: linear-gradient(180deg, rgba(11,24,38,.98), rgba(11,24,38,.86));
            border: 1px solid var(--line);
            border-radius: 18px;
            box-shadow: 0 20px 70px rgba(0,0,0,.55);
            transform: translateX(120%);
            transition: transform .22s ease;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .drawer.open {
            transform: translateX(0);
        }
        
        .drawer .card-hd {
            border-bottom: 1px solid var(--line);
        }
        
        .drawer .card-bd {
            overflow: auto;
            min-height: 0;
        }
        
        .kv {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 8px 10px;
            font-size: 12.5px;
        }
        
        .kv b {
            color: var(--muted);
            font-weight: 700;
        }
        
        .divider {
            height: 1px;
            background: var(--line);
            margin: 10px 0;
        }
        
        .toast {
            position: fixed;
            left: 14px;
            bottom: 14px;
            background: rgba(11,24,38,.92);
            border: 1px solid var(--line);
            border-radius: 14px;
            padding: 10px 12px;
            box-shadow: 0 16px 60px rgba(0,0,0,.45);
            color: var(--text);
            font-size: 12.5px;
            display: none;
            z-index: 6000;
            max-width: calc(100vw - 28px);
        }
        
        .toast.show {
            display: block;
        }
        
        .toast .t {
            color: var(--muted);
            font-size: 11px;
            margin-top: 4px;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: var(--mono);
            font-weight: 800;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 999px;
            border: 1px solid var(--line);
            background: rgba(16,40,68,.45);
            color: var(--text);
            white-space: nowrap;
        }
        
        /* Leaflet dark-ish */
        .leaflet-control-zoom a {
            background: rgba(11,24,38,.85) !important;
            color: var(--text) !important;
            border: 1px solid var(--line) !important;
        }
        
        .leaflet-popup-content-wrapper {
            background: rgba(11,24,38,.95);
            color: var(--text);
            border: 1px solid var(--line);
            border-radius: 16px;
            box-shadow: 0 20px 70px rgba(0,0,0,.55);
        }
        
        .leaflet-popup-tip {
            background: rgba(11,24,38,.95);
        }
        
        .leaflet-container {
            background: #06101a;
            flex: 1;
        }
        
        /* Responsive */
        @media (max-width: 1100px) {
            body {
                overflow: auto;
            }
            
            header {
                height: auto;
                padding: 12px 14px;
                align-items: flex-start;
            }
            
            .brand .sub {
                max-width: 95vw;
                white-space: normal;
            }
            
            main {
                height: auto;
                grid-template-columns: 1fr;
                overflow: visible;
            }
            
            .map-wrap {
                height: 55vh;
                min-height: 300px;
            }
            
            .drawer {
                right: 14px;
                left: 14px;
                width: auto;
                height: min(78vh, 720px);
                top: 76px;
            }
            
            .grid2 {
                grid-template-columns: 1fr;
            }
            
            .map-toolbar .input {
                flex: 1;
                min-width: 180px;
            }
        }
        
        @media (max-width: 520px) {
            .pill {
                display: none;
            }
            
            .map-toolbar {
                gap: 8px;
            }
            
            .map-toolbar .select {
                flex: 1;
                min-width: 140px;
            }
            
            .map-toolbar .chip {
                display: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="brand">
            <span class="dot"></span>
            <div>
                <div>AIDesk — PNH Polna <small>Command & Operations</small></div>
                <div class="sub">15,000 agents • HR/KYC • Assignments • Training • Vehicles/Weaponry • Incidents • Geo-Ops</div>
            </div>
        </div>
        <div class="top-actions">
            <div class="pill">Data refresh: <b id="refreshLabel">—</b></div>
            <div class="pill">Vehicles: <b id="kVehicles">0</b></div>
            <div class="pill">Agents: <b id="kAgents">0</b></div>
            <button class="btn secondary" onclick="UI.openCopilot()">Copilot</button>
            <button class="btn" onclick="UI.centerToPNH()">Center Map</button>
        </div>
    </header>
    
    <main>
        <!-- LEFT: MAP + FLEET TABLE -->
        <section class="card">
            <div class="card-hd">
                <div>
                    <h3>Operational Map — Vehicles (GPS/OBD2)</h3>
                    <div class="sub">Live markers from <span class="mono">/assets/data/vehicles.json</span> (auto refresh + status + clustering)</div>
                </div>
                <div class="row">
                    <span class="chip">Online <span class="badge" id="kOnline">0</span></span>
                    <span class="chip">Stale <span class="badge" id="kStale">0</span></span>
                    <span class="chip">Alerts <span class="badge" id="kAlerts">0</span></span>
                    <button class="btn secondary" onclick="DATA.forceReload()">Reload</button>
                </div>
            </div>
            <div class="map-wrap">
                <div class="map-toolbar">
                    <input class="input" id="qSearch" placeholder="Search vehicle / agent / unit / plate / VIN / ID…" oninput="UI.applyFilters()"/>
                    <select class="select" id="fStatus" onchange="UI.applyFilters()">
                        <option value="all">All status</option>
                        <option value="online">Online</option>
                        <option value="stale">Stale</option>
                        <option value="offline">Offline</option>
                        <option value="alert">Alert</option>
                    </select>
                    <select class="select" id="fUnit" onchange="UI.applyFilters()">
                        <option value="all">All units</option>
                    </select>
                    <select class="select" id="fType" onchange="UI.applyFilters()">
                        <option value="all">All types</option>
                    </select>
                    <span class="chip">Refresh <span class="badge" id="refreshEvery">10s</span></span>
                    <button class="btn secondary" onclick="UI.toggleDrawer()">Profile</button>
                    <button class="btn danger" onclick="INCIDENT.openNew()">New Incident</button>
                </div>
                <div id="map"></div>
            </div>
            <div class="card-bd">
                <div class="kpi">
                    <div class="box">
                        <div class="lbl">Map view</div>
                        <div class="val" id="kMap">—</div>
                        <div class="tag">Zoom / center</div>
                    </div>
                    <div class="box">
                        <div class="lbl">Active assignments</div>
                        <div class="val" id="kAssignments">0</div>
                        <div class="tag">From <span class="mono">/assets/data/assignments.json</span></div>
                    </div>
                    <div class="box">
                        <div class="lbl">Incidents today</div>
                        <div class="val" id="kIncidents">0</div>
                        <div class="tag">Captured in AIDesk tasks/incident store</div>
                    </div>
                </div>
                <div class="section">
                    <div class="row" style="justify-content:space-between;">
                        <h4 style="margin:0;">Fleet — filtered view</h4>
                        <div class="small">Click row to open profile & center marker</div>
                    </div>
                    <div style="overflow:auto; max-height:260px; border-radius:14px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Vehicle</th>
                                    <th>Unit</th>
                                    <th>Agent</th>
                                    <th>Last GPS</th>
                                    <th class="mono">Speed</th>
                                </tr>
                            </thead>
                            <tbody id="fleetRows"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- RIGHT: COMMAND + INCIDENTS + COPILOT -->
        <section class="card">
            <div class="card-hd">
                <div>
                    <h3>Command Center — Assignments • Incidents • Copilot</h3>
                    <div class="sub">Tasking, incident capture, and Ollama-assisted analysis & decisions</div>
                </div>
                <div class="tabs">
                    <div class="tab active" data-tab="ops" onclick="UI.setTab('ops')">Ops</div>
                    <div class="tab" data-tab="inc" onclick="UI.setTab('inc')">Incidents</div>
                    <div class="tab" data-tab="cop" onclick="UI.setTab('cop')">Copilot</div>
                </div>
            </div>
            <div class="card-bd split">
                <!-- OPS TAB -->
                <div id="tab-ops" style="display:block; min-height:0;">
                    <div class="grid2">
                        <div class="section">
                            <h4>Assignment Snapshot</h4>
                            <div class="small">From <span class="mono">/assets/data/assignments.json</span>. Click to open.</div>
                            <div class="divider"></div>
                            <div id="assignList" class="small">Loading…</div>
                        </div>
                        <div class="section">
                            <h4>Quick Task</h4>
                            <div class="small">Creates an action item into AIDesk store (<span class="mono">POST /api/aidesk/items</span>)</div>
                            <div class="divider"></div>
                            <div class="row">
                                <input class="input" id="taskTitle" placeholder="Task title (e.g., Dispatch team to Zone 3)…" style="flex:1; min-width:0;"/>
                            </div>
                            <div class="row" style="margin-top:10px;">
                                <select class="select" id="taskPriority">
                                    <option value="normal">Priority: Normal</option>
                                    <option value="high">Priority: High</option>
                                    <option value="critical">Priority: Critical</option>
                                </select>
                                <select class="select" id="taskType">
                                    <option value="task">Type: Task</option>
                                    <option value="dispatch">Type: Dispatch</option>
                                    <option value="audit">Type: Audit</option>
                                    <option value="investigation">Type: Investigation</option>
                                </select>
                            </div>
                            <div class="row" style="margin-top:10px;">
                                <button class="btn" onclick="TASKS.createQuick()">Create Task</button>
                                <button class="btn secondary" onclick="COPILOT.generateIncidentActions()">Generate Actions from Incidents</button>
                            </div>
                        </div>
                    </div>
                    <div class="section" style="margin-top:12px;">
                        <h4>Agent Directory (fast lookup)</h4>
                        <div class="small">From <span class="mono">/assets/data/hrfiles.json</span> — HR/KYC/skills/contacts.</div>
                        <div class="divider"></div>
                        <div class="row">
                            <input class="input" id="agentSearch" placeholder="Search agent name / badge / NIU / unit…" oninput="UI.renderAgentResults()"/>
                            <button class="btn secondary" onclick="UI.clearAgentSearch()">Clear</button>
                        </div>
                        <div id="agentResults" style="margin-top:10px; max-height:200px; overflow:auto;"></div>
                    </div>
                </div>
                
                <!-- INCIDENTS TAB -->
                <div id="tab-inc" style="display:none; min-height:0;">
                    <div class="section">
                        <div class="row" style="justify-content:space-between;">
                            <h4 style="margin:0;">Incidents Feed (AIDesk items)</h4>
                            <button class="btn danger" onclick="INCIDENT.openNew()">Report Incident</button>
                        </div>
                        <div class="small">This view lists AIDesk items of type <span class="mono">incident</span> (from <span class="mono">/api/aidesk/items</span>).</div>
                        <div class="divider"></div>
                        <div id="incidentFeed" class="small">Loading…</div>
                    </div>
                </div>
                
                <!-- COPILOT TAB -->
                <div id="tab-cop" style="display:none; min-height:0;">
                    <div class="chat">
                        <div class="section">
                            <h4>Ollama Copilot — Polna Operations</h4>
                            <div class="hint">
                                Use Copilot for: incident triage, dispatch planning, assignment conflicts, training gaps, audit recommendations, and task generation.<br/>
                                Recommended endpoint: <span class="mono">POST /api/ollama/chat</span> (server-side proxy).
                            </div>
                            <div class="row" style="margin-top:10px;">
                                <select class="select" id="copilotMode">
                                    <option value="triage">Mode: Incident Triage</option>
                                    <option value="dispatch">Mode: Dispatch & Routing</option>
                                    <option value="hr">Mode: HR/KYC/Skills Analysis</option>
                                    <option value="risk">Mode: Risk & Compliance</option>
                                    <option value="tasks">Mode: Task Builder</option>
                                </select>
                                <button class="btn secondary" onclick="COPILOT.suggestActions()">Suggest Actions</button>
                                <button class="btn secondary" onclick="COPILOT.summarizeSituation()">Summarize Situation</button>
                            </div>
                        </div>
                        <div class="chat-log" id="chatLog"></div>
                        <div class="chat-input">
                            <textarea id="chatText" placeholder="Ask Copilot: e.g., 'We have 3 alerts in Zone 5; propose dispatch plan, nearest units, tasks, and risks…'"></textarea>
                            <button class="btn" onclick="COPILOT.send()">Send</button>
                        </div>
                        <div class="hint">
                            Tip: Select a vehicle or agent first, then ask Copilot — it will include the selected context automatically.
                        </div>
                    </div>
                </div>
                
                <!-- bottom "system status" -->
                <div class="section">
                    <div class="row" style="justify-content:space-between;">
                        <div>
                            <b>System</b>
                            <div class="small" id="sysLine">Starting…</div>
                        </div>
                        <div class="row">
                            <span class="status" id="apiBadge"><span class="s-dot s-good"></span> API</span>
                            <span class="status" id="ollamaBadge"><span class="s-dot s-warn"></span> Ollama</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Right Drawer: selection profile -->
    <div class="drawer" id="drawer">
        <div class="card-hd">
            <div>
                <h3 id="drawerTitle">Profile</h3>
                <div class="sub" id="drawerSub">Select a vehicle or agent.</div>
            </div>
            <div class="row">
                <button class="btn secondary" onclick="UI.closeDrawer()">Close</button>
            </div>
        </div>
        <div class="card-bd">
            <div id="drawerBody" class="small">No selection.</div>
            <div class="divider"></div>
            <div class="section">
                <h4>Actions</h4>
                <div class="row">
                    <button class="btn" onclick="TASKS.dispatchFromSelection()">Dispatch Task</button>
                    <button class="btn danger" onclick="INCIDENT.openNew(true)">Report Incident</button>
                    <button class="btn secondary" onclick="COPILOT.analyzeSelection()">Analyze in Copilot</button>
                </div>
                <div class="hint" style="margin-top:8px;">
                    Dispatch Task creates an AIDesk item with coordinates + selection context, so teams can act immediately.
                </div>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast">
        <div id="toastMsg">—</div>
        <div class="t" id="toastSub">—</div>
    </div>
    
    <script src="/assets/js/polna.js"></script>
</body>
</html>