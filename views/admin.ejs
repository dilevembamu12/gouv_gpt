<!doctype html>
<html lang="fr" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GouvBrain Admin ‚Ä¢ MinIO & n8n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>
  <style>
    :root { --c-bg-body: #000; --c-accent: #006fee; --c-card: #111; --c-border: #333; }
    body { background-color: var(--c-bg-body); color: white; height: 100vh; display: flex; overflow: hidden; }
    
    .admin-sidebar { width: 300px; background: #050505; border-right: 1px solid var(--c-border); padding: 20px; display: flex; flex-direction: column; }
    .admin-main { flex: 1; overflow-y: auto; padding: 40px; background: radial-gradient(circle at 50% 0%, #1a1a1a 0%, #000 50%); }
    
    .persona-nav-item { padding: 10px; border-radius: 8px; cursor: pointer; display: flex; gap: 10px; margin-bottom: 4px; border: 1px solid transparent; }
    .persona-nav-item:hover { background: #1a1a1a; }
    .persona-nav-item.active { background: rgba(0, 111, 238, 0.1); border-color: rgba(0, 111, 238, 0.3); color: var(--c-accent); }
    
    .glass-card { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--c-border); border-radius: 16px; padding: 24px; margin-bottom: 24px; }
    .form-control { background: #080808; border: 1px solid var(--c-border); color: white; }
    .form-control:focus { background: #080808; color: white; border-color: var(--c-accent); box-shadow: none; }
    
    .knowledge-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--c-border); background: rgba(255,255,255,0.02); border-radius: 6px; margin-bottom: 4px; }
    .btn-del { color: #666; cursor: pointer; transition: 0.2s; }
    .btn-del:hover { color: #ef4444; }
    
    /* Tabs */
    .nav-pills .nav-link { color: #888; background: transparent; border-radius: 6px; font-size: 13px; font-weight: 500; }
    .nav-pills .nav-link.active { background: #222; color: white; border: 1px solid #444; }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="admin-sidebar">
    <div class="d-flex align-items-center gap-2 mb-4">
        <a href="/" class="btn btn-sm btn-outline-secondary rounded-circle"><i class="bi bi-arrow-left"></i></a>
        <h5 class="m-0 fw-bold">GouvBrain</h5>
    </div>
    <div id="personaList" class="flex-grow-1 overflow-auto"></div>
    <button class="btn btn-outline-primary w-100 mt-3" onclick="createNewPersona()"><i class="bi bi-plus-lg"></i> Nouvel Expert</button>
  </aside>

  <!-- MAIN -->
  <main class="admin-main">
    <div id="configContainer" style="max-width: 800px; margin: 0 auto;">
         <div class="text-center py-5 opacity-25"><i class="bi bi-person-gear fs-1"></i><h3 class="mt-3">S√©lectionner un expert</h3></div>
    </div>
  </main>

  <!-- TOAST -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastMsg">Action effectu√©e</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let allPersonas = [];
    let selectedPersonaId = null;

    async function load() {
        try {
            const res = await fetch('/api/admin/personas');
            const data = await res.json();
            allPersonas = data.personas;
            renderPersonaList();
            if(selectedPersonaId && allPersonas.find(p => p.id === selectedPersonaId)) {
                selectPersona(selectedPersonaId);
            }
        } catch(e) { console.error(e); }
    }

    function renderPersonaList() {
        document.getElementById('personaList').innerHTML = allPersonas.map(p => `
            <div class="persona-nav-item ${selectedPersonaId === p.id ? 'active' : ''}" onclick="selectPersona('${p.id}')">
                <span class="fs-4">${p.avatarEmoji}</span>
                <div class="overflow-hidden w-100">
                    <div class="fw-bold text-truncate" style="font-size:14px;">${p.ministry}</div>
                    <div class="small opacity-50 text-truncate">${p.name}</div>
                </div>
            </div>`).join('');
    }

    function selectPersona(id) {
        selectedPersonaId = id;
        renderPersonaList();
        const p = allPersonas.find(p => p.id === id);
        
        document.getElementById('configContainer').innerHTML = `
            <div class="d-flex align-items-center gap-3 mb-4">
                <div class="fs-1">${p.avatarEmoji}</div>
                <h2 class="fw-bold m-0">${p.ministry}</h2>
                <div class="ms-auto">
                    <button class="btn btn-sm btn-outline-info" onclick="generateWithGemini()"><i class="bi bi-stars"></i> Gemini Auto-Fill</button>
                </div>
            </div>

            <div class="glass-card">
                <h6 class="mb-3 fw-bold text-uppercase text-secondary" style="font-size:11px;">Identit√© & Prompt</h6>
                <div class="row g-3">
                    <div class="col-md-2"><label class="form-label small">Emoji</label><input type="text" id="pEmoji" class="form-control text-center fs-4" value="${p.avatarEmoji}"></div>
                    <div class="col-md-5"><label class="form-label small">Nom</label><input type="text" id="pName" class="form-control" value="${p.name}"></div>
                    <div class="col-md-5"><label class="form-label small">Minist√®re</label><input type="text" id="pMinistry" class="form-control" value="${p.ministry}"></div>
                    <div class="col-12"><label class="form-label small">System Prompt</label><textarea id="pPrompt" class="form-control font-monospace" rows="4">${p.systemPrompt || ''}</textarea></div>
                </div>
                <div class="text-end mt-3">
                    <button class="btn btn-sm btn-danger opacity-50" onclick="deletePersona('${p.id}')">Supprimer</button>
                    <button class="btn btn-primary px-4" onclick="savePersona()">Enregistrer</button>
                </div>
            </div>

            <div class="glass-card">
                <h6 class="mb-3 fw-bold text-uppercase text-secondary" style="font-size:11px;">Base de Connaissances (MinIO + n8n)</h6>
                <ul class="nav nav-pills mb-3 gap-2">
                    <li class="nav-item"><button class="nav-link active py-1" data-bs-toggle="pill" data-bs-target="#pane-file">Fichier</button></li>
                    <li class="nav-item"><button class="nav-link py-1" data-bs-toggle="pill" data-bs-target="#pane-text">Note Rapide</button></li>
                </ul>

                <div class="tab-content mb-4 p-3 rounded" style="border:1px dashed #333;">
                    <!-- TAB FILE -->
                    <div class="tab-pane fade show active" id="pane-file">
                        <div class="d-flex gap-2">
                            <input type="file" id="pKnowledgeFile" class="form-control">
                            <button id="btnUploadFile" class="btn btn-light btn-sm fw-bold" onclick="uploadFile('${p.id}')">Indexer</button>
                        </div>
                    </div>
                    <!-- TAB TEXT -->
                    <div class="tab-pane fade" id="pane-text">
                        <input type="text" id="pTxtTitle" class="form-control mb-2" placeholder="Titre de la note">
                        <textarea id="pTxtContent" class="form-control mb-2" rows="3" placeholder="Contenu..."></textarea>
                        <div class="text-end"><button id="btnUploadTxt" class="btn btn-light btn-sm fw-bold" onclick="uploadText('${p.id}')">Ajouter</button></div>
                    </div>
                </div>

                <div class="d-flex flex-column gap-2">
                    ${(p.knowledge || []).length === 0 ? '<div class="text-center text-muted small py-3">Vide</div>' : ''}
                    ${(p.knowledge || []).slice().reverse().map(k => `
                        <div class="knowledge-item">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-${k.type === 'file' ? 'file-earmark-pdf' : 'file-text'} text-primary"></i>
                                <div class="small fw-bold">${k.name}</div>
                            </div>
                            <i class="bi bi-trash btn-del" onclick="deleteDoc('${p.id}', '${k.name}')"></i>
                        </div>`).join('')}
                </div>
            </div>
        `;
    }

    // --- ACTIONS ---

    async function savePersona() {
        const payload = {
            id: selectedPersonaId,
            avatarEmoji: document.getElementById('pEmoji').value,
            name: document.getElementById('pName').value,
            ministry: document.getElementById('pMinistry').value,
            systemPrompt: document.getElementById('pPrompt').value
        };
        await fetch('/api/admin/personas', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        showToast("Sauvegard√©"); load();
    }

    async function uploadFile(id) {
        const file = document.getElementById('pKnowledgeFile').files[0];
        if(!file) return alert("Fichier requis");
        
        const btn = document.getElementById('btnUploadFile');
        btn.innerHTML = '...'; btn.disabled = true;

        const fd = new FormData(); fd.append('file', file);
        const res = await fetch(`/api/admin/personas/${id}/knowledge/file`, { method: 'POST', body: fd });
        
        btn.innerHTML = 'Indexer'; btn.disabled = false;
        if(res.ok) { showToast("Fichier envoy√© √† n8n"); load(); }
        else alert("Erreur upload");
    }

    async function uploadText(id) {
        const title = document.getElementById('pTxtTitle').value;
        const content = document.getElementById('pTxtContent').value;
        if(!title || !content) return alert("Champs requis");

        const btn = document.getElementById('btnUploadTxt');
        btn.innerHTML = '...'; btn.disabled = true;

        const res = await fetch(`/api/admin/personas/${id}/knowledge/text`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ title, content })
        });
        
        btn.innerHTML = 'Ajouter'; btn.disabled = false;
        if(res.ok) { showToast("Note envoy√©e √† n8n"); load(); }
        else alert("Erreur ajout");
    }

    async function deleteDoc(pid, fname) {
        if(confirm("Supprimer ?")) {
            await fetch(`/api/admin/personas/${pid}/knowledge/${fname}`, { method: 'DELETE' });
            load();
        }
    }

    async function createNewPersona() {
        const id = 'p_' + Math.random().toString(36).substr(2, 5);
        allPersonas.push({ id, name: "Nouveau", ministry: "Nouveau", avatarEmoji: "üë§", knowledge: [] });
        selectPersona(id);
    }
    
    async function deletePersona(id) {
        if(confirm("Supprimer l'expert ?")) {
            await fetch(`/api/admin/personas/${id}`, { method: 'DELETE' });
            selectedPersonaId = null; load();
        }
    }
    
    // Gemini Generator
    async function generateWithGemini() {
        const ministry = document.getElementById('pMinistry').value;
        if(!ministry) return alert("Entrez un minist√®re d'abord");
        const res = await fetch('/api/gemini/persona', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ministry}) });
        const json = await res.json();
        if(json.ok) {
            document.getElementById('pName').value = json.data.name;
            document.getElementById('pEmoji').value = json.data.avatarEmoji;
            document.getElementById('pPrompt').value = json.data.systemPrompt;
        }
    }

    function showToast(msg) {
        document.getElementById('toastMsg').innerText = msg;
        new bootstrap.Toast(document.getElementById('liveToast')).show();
    }

    load();
  </script>
</body>
</html>